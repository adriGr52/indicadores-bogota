<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>API Fecundidad Temprana - Dashboard</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:20px; line-height:1.35}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{font-size:22px; margin:0}
    section{margin-top:18px; padding:14px; border:1px solid #e5e7eb; border-radius:12px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end}
    label{font-size:12px; color:#374151; display:block; margin-bottom:4px}
    input, select, button{padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; font-size:14px}
    button{cursor:pointer}
    table{border-collapse:collapse; width:100%; margin-top:10px; font-size:13px}
    th, td{border:1px solid #e5e7eb; padding:6px 8px; text-align:left}
    th{background:#f9fafb}
    .muted{color:#6b7280}
    .tag{display:inline-block; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px}
    .ok{color:#047857}
    .err{color:#b91c1c}
    .small{font-size:12px}
    .grid{display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    #log{white-space:pre-wrap; font-size:12px; color:#374151; background:#f9fafb; padding:8px; border-radius:8px}
  </style>
</head>
<body>
<header>
  <h1>API Fecundidad Temprana · <span class="muted small">Objetivo 1: caracterización</span></h1>
  <div><a href="/docs" target="_blank">/docs</a></div>
</header>

<section>
  <h3>Cargar archivo consolidado (.xlsx)</h3>
  <div class="row">
    <input type="file" id="file" accept=".xlsx,.xls"/>
    <button onclick="upload()">Subir</button>
  </div>
  <div id="uploadResult" class="small muted"></div>
</section>

<section>
  <h3>Metadatos &amp; Indicadores</h3>
  <div class="row">
    <button onclick="loadMeta()">Refrescar metadatos</button>
    <input id="buscarInd" placeholder="Buscar indicador..."/>
    <button onclick="listIndicadores()">Listar</button>
  </div>
  <div id="meta" class="small"></div>
  <div id="indicadores"></div>
</section>

<section>
  <h3>Caracterización por territorio</h3>
  <div class="grid">
    <div>
      <label>Indicador</label>
      <input id="indCar" placeholder="Nombre exacto del indicador"/>
    </div>
    <div>
      <label>Nivel</label>
      <select id="nivelCar">
        <option>LOCALIDAD</option>
        <option>UPZ</option>
      </select>
    </div>
    <div>
      <label>Año (opcional)</label>
      <input id="anioCar" type="number" placeholder="ej. 2020"/>
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button onclick="runCaracterizacion()">Calcular</button>
  </div>
  <div id="caracterizacion"></div>
</section>

<section>
  <h3>Asociación con otros determinantes (correlaciones)</h3>
  <div class="grid">
    <div>
      <label>Indicador objetivo (fecundidad)</label>
      <input id="indTarget" placeholder="Nombre exacto del indicador de fecundidad"/>
    </div>
    <div>
      <label>Nivel</label>
      <select id="nivelAsoc">
        <option>LOCALIDAD</option>
        <option>UPZ</option>
      </select>
    </div>
    <div>
      <label>Año (opcional)</label>
      <input id="anioAsoc" type="number" placeholder="ej. 2020"/>
    </div>
    <div>
      <label>Top</label>
      <input id="topAsoc" type="number" value="10" min="3" max="50"/>
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button onclick="runAsociacion()">Analizar</button>
  </div>
  <div id="asociacion"></div>
</section>

<section>
  <h3>Serie temporal</h3>
  <div class="grid">
    <div>
      <label>Indicador</label>
      <input id="indSerie"/>
    </div>
    <div>
      <label>Nivel</label>
      <select id="nivelSerie">
        <option>LOCALIDAD</option>
        <option>UPZ</option>
      </select>
    </div>
    <div>
      <label>Territorio</label>
      <input id="terrSerie" placeholder="Nombre exacto"/>
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button onclick="runSerie()">Obtener</button>
  </div>
  <div id="serie" class="mono small"></div>
</section>

<section>
  <details>
    <summary>Log</summary>
    <div id="log"></div>
  </details>
</section>

<script>
const log = (msg) => {
  const el = document.getElementById('log');
  el.textContent += `\n${new Date().toLocaleTimeString()} · ${msg}`;
}

async function upload(){
  const f = document.getElementById('file').files[0];
  if(!f){ alert('Selecciona un archivo'); return; }
  const fd = new FormData();
  fd.append('file', f);
  const res = await fetch('/upload/excel', { method: 'POST', body: fd });
  const js = await res.json();
  document.getElementById('uploadResult').textContent = JSON.stringify(js, null, 2);
  log('Upload -> ' + res.status);
}

async function loadMeta(){
  const r = await fetch('/metadatos');
  const js = await r.json();
  document.getElementById('meta').textContent = JSON.stringify(js, null, 2);
  log('Metadatos -> ' + r.status);
}

async function listIndicadores(){
  const q = document.getElementById('buscarInd').value || '';
  const r = await fetch('/indicadores' + (q?`?buscar=${encodeURIComponent(q)}`:''));
  const js = await r.json();
  const rows = Array.isArray(js) ? js : [];
  const html = ['<table><thead><tr><th>Indicador</th><th>Unidad</th><th>Registros</th></tr></thead><tbody>',
    ...rows.map(o => `<tr><td>${o.indicador}</td><td>${o.unidad||''}</td><td>${o.registros}</td></tr>`),
    '</tbody></table>'
  ].join('');
  document.getElementById('indicadores').innerHTML = html;
  log('Indicadores -> ' + r.status + ' (' + rows.length + ' filas)');
}

async function runCaracterizacion(){
  const ind = document.getElementById('indCar').value.trim();
  const nivel = document.getElementById('nivelCar').value;
  const anio = document.getElementById('anioCar').value.trim();
  if(!ind){ alert('Ingresa el nombre exacto del indicador.'); return; }
  const url = new URL(location.origin + '/caracterizacion');
  url.searchParams.set('indicador', ind);
  url.searchParams.set('nivel', nivel);
  if(anio) url.searchParams.set('año', anio);
  const r = await fetch(url);
  const js = await r.json();
  if(js.datos){
    const rows = js.datos;
    const html = ['<div class="small muted">Promedio general: '+ js.resumen.promedio_general +'</div>',
      '<table><thead><tr><th>Territorio</th><th>n</th><th>Promedio</th><th>Mediana</th><th>Q1</th><th>Q3</th><th>Mín</th><th>Máx</th><th>DE</th><th>CV%</th></tr></thead><tbody>',
      ...rows.map(o => `<tr><td>${o.territorio}</td><td>${o.n}</td><td>${o.promedio}</td><td>${o.mediana}</td><td>${o.q1}</td><td>${o.q3}</td><td>${o.min}</td><td>${o.max}</td><td>${o.desv_estandar}</td><td>${o.cv_pct}</td></tr>`),
      '</tbody></table>'
    ].join('');
    document.getElementById('caracterizacion').innerHTML = html;
  }else{
    document.getElementById('caracterizacion').textContent = JSON.stringify(js, null, 2);
  }
  log('Caracterización -> ' + r.status);
}

async function runAsociacion(){
  const ind = document.getElementById('indTarget').value.trim();
  const nivel = document.getElementById('nivelAsoc').value;
  const anio = document.getElementById('anioAsoc').value.trim();
  const top = document.getElementById('topAsoc').value || 10;
  if(!ind){ alert('Ingresa el indicador objetivo'); return; }
  const url = new URL(location.origin + '/analisis/asociacion');
  url.searchParams.set('indicador_objetivo', ind);
  url.searchParams.set('nivel', nivel);
  url.searchParams.set('top', top);
  if(anio) url.searchParams.set('año', anio);
  const r = await fetch(url);
  const js = await r.json();
  if(js.comparaciones){
    const rows = js.comparaciones;
    const html = ['<table><thead><tr><th>Indicador comparado</th><th>Territorios</th><th>Pearson r (p)</th><th>Spearman ρ (p)</th></tr></thead><tbody>',
      ...rows.map(o => `<tr><td>${o.indicador_comparado}</td><td>${o.territorios}</td><td>${o.pearson_r} (${o.pearson_p})</td><td>${o.spearman_rho} (${o.spearman_p})</td></tr>`),
      '</tbody></table>'
    ].join('');
    document.getElementById('asociacion').innerHTML = html;
  }else{
    document.getElementById('asociacion').textContent = JSON.stringify(js, null, 2);
  }
  log('Asociación -> ' + r.status);
}

async function runSerie(){
  const ind = document.getElementById('indSerie').value.trim();
  const nivel = document.getElementById('nivelSerie').value;
  const terr = document.getElementById('terrSerie').value.trim();
  if(!ind || !terr){ alert('Completa indicador y territorio'); return; }
  const url = new URL(location.origin + '/datos/series');
  url.searchParams.set('indicador', ind);
  url.searchParams.set('nivel', nivel);
  url.searchParams.set('territorio', terr);
  const r = await fetch(url);
  const js = await r.json();
  document.getElementById('serie').textContent = JSON.stringify(js, null, 2);
  log('Serie -> ' + r.status);
}
</script>
</body>
</html>
