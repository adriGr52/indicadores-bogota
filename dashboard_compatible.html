<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fecundidad Temprana Bogot√° v4.3.1</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        .card { 
            background:#fff; 
            border-radius:1rem; 
            box-shadow:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            border:1px solid #e5e7eb; 
        }
        .btn { 
            display:inline-flex; 
            align-items:center; 
            gap:.5rem; 
            padding:.75rem 1rem; 
            border-radius:.5rem; 
            border:1px solid #d1d5db; 
            background:#fff; 
            transition: all .2s; 
            cursor: pointer; 
            text-align: center;
            font-size: 0.875rem;
        }
        .btn:hover { background:#f9fafb; transform: translateY(-1px); }
        .btn-primary { background:#2563eb; border-color:#2563eb; color:#fff; }
        .btn-primary:hover { background:#1d4ed8; }
        .btn-primary:disabled { background:#9ca3af; cursor: not-allowed; transform: none; }
        
        .tabs { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.5rem; 
            margin-bottom: 2rem; 
        }
        .tabs button[aria-selected="true"] { 
            background:#1e40af; 
            color:white; 
            border-color:#1e40af; 
        }
        .tabs button { 
            background:#eff6ff; 
            color:#1e3a8a; 
            border:1px solid #bfdbfe; 
            padding: 1rem;
            text-align: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
            min-height: 4rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
        }
        .tabs button:hover { background:#dbeafe; border-color:#93c5fd; }
        
        .loading { opacity: 0.5; pointer-events: none; }
        .spinner { 
            border:3px solid #e5e7eb; 
            border-top-color:#2563eb; 
            border-radius:50%; 
            width:20px; 
            height:20px; 
            animation: spin 1s linear infinite; 
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .alert { padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
        .alert-success { background: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .alert-error { background: #fef2f2; border: 1px solid #dc2626; color: #dc2626; }
        .alert-info { background: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        .alert-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        
        /* Chart containers espec√≠ficos */
        .chart-small { position: relative; height: 300px; }
        .chart-medium { position: relative; height: 400px; }
        .chart-scrollable { 
            position: relative; 
            height: 400px; 
            overflow-x: auto; 
            overflow-y: hidden;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        .chart-scrollable canvas { min-width: 100%; }
        
        /* Form styles */
        select, input { 
            width: 100%; 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            font-size: 0.875rem;
            background: white;
        }
        select:focus, input:focus { 
            outline: none; 
            ring: 2px; 
            ring-color: #2563eb; 
            border-color: #2563eb; 
        }
        
        .kpi-card {
            text-align: center;
            padding: 1rem;
        }
        .kpi-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        .kpi-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .tabs { 
                grid-template-columns: repeat(2, 1fr); 
            }
            .chart-small, .chart-medium { height: 250px; }
            .chart-scrollable { height: 300px; }
        }
        
        @media (max-width: 640px) {
            .tabs { 
                grid-template-columns: 1fr; 
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-600 text-white">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">
                        üèõÔ∏è Exploraci√≥n Determinantes Fecundidad Temprana
                    </h1>
                    <p class="mt-1 text-blue-100">
                        Bogot√° D.C. ‚Ä¢ An√°lisis territorial por UPZ (Cohortes 10-14, 15-19 a√±os) v4.3.1
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btnRefresh" class="btn bg-gray-700 text-white border-gray-600 hover:bg-gray-600">
                        <i class="ti ti-refresh"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        <!-- KPIs -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card kpi-card">
                <div class="kpi-number" id="kpiTotal">-</div>
                <div class="kpi-label">Registros Totales</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-number" id="kpiIndicadores">-</div>
                <div class="kpi-label">Indicadores √önicos</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-number" id="kpiLocalidades">-</div>
                <div class="kpi-label">Localidades</div>
            </div>
            <div class="card kpi-card">
                <div class="kpi-number" id="kpiUpz">-</div>
                <div class="kpi-label">UPZ</div>
            </div>
        </section>

        <!-- Upload Section -->
        <section class="card p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i class="ti ti-upload"></i> Carga de Datos Excel
                </h2>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">POST /upload/excel</span>
            </div>
            <div class="grid md:grid-cols-3 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-2">Archivo Excel (.xlsx, .xls)</label>
                    <input id="fileInput" type="file" accept=".xlsx,.xls" 
                           class="w-full">
                </div>
                <div class="flex gap-2">
                    <button id="btnUpload" class="btn btn-primary">
                        <i class="ti ti-cloud-upload"></i> Subir Archivo
                    </button>
                    <div id="uploadSpinner" class="spinner hidden"></div>
                </div>
            </div>
            <div id="uploadResult" class="mt-4"></div>
        </section>

        <!-- Analysis Tabs -->
        <section class="space-y-4">
            <div class="tabs">
                <button class="btn" data-tab="caracterizacion" aria-selected="true">
                    <i class="ti ti-chart-bar text-xl"></i>
                    <span class="text-sm font-medium">Caracterizaci√≥n</span>
                    <span class="text-xs opacity-75">Estad√≠sticas UPZ</span>
                </button>
                <button class="btn" data-tab="series">
                    <i class="ti ti-trending-up text-xl"></i>
                    <span class="text-sm font-medium">Series</span>
                    <span class="text-xs opacity-75">Evoluci√≥n temporal</span>
                </button>
                <button class="btn" data-tab="asociacion">
                    <i class="ti ti-chart-dots text-xl"></i>
                    <span class="text-sm font-medium">Asociaci√≥n</span>
                    <span class="text-xs opacity-75">Correlaciones</span>
                </button>
                <button class="btn" data-tab="theil">
                    <i class="ti ti-balance text-xl"></i>
                    <span class="text-sm font-medium">Desigualdad</span>
                    <span class="text-xs opacity-75">√çndice Theil</span>
                </button>
            </div>

            <!-- Caracterizaci√≥n -->
            <div id="tab-caracterizacion" class="card p-6 space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">Caracterizaci√≥n Territorial</h3>
                
                <!-- FILTROS CORREGIDOS: SEPARADOS -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium mb-2">Indicador *</label>
                        <select id="caracIndicador">
                            <option value="">Seleccionar indicador...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Localidad</label>
                        <select id="caracLocalidad">
                            <option value="">Todas las localidades</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">UPZ</label>
                        <select id="caracUpz">
                            <option value="">Todas las UPZ</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnCaracterizar" class="btn btn-primary w-full">
                            <i class="ti ti-chart-bar"></i> Analizar
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-4 flex items-center justify-between">
                            Top 10 UPZ por Indicador
                            <button id="btnDescargar" class="btn text-xs">
                                <i class="ti ti-download"></i> Exportar
                            </button>
                        </h4>
                        <div class="chart-small">
                            <canvas id="chartCaracterizacion"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-4">Estad√≠sticas Descriptivas</h4>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto">
                            <table id="tableCaracterizacion" class="w-full text-sm">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left border-b">UPZ</th>
                                        <th class="p-2 text-center border-b">N</th>
                                        <th class="p-2 text-right border-b">Promedio</th>
                                        <th class="p-2 text-right border-b">Mediana</th>
                                        <th class="p-2 text-right border-b">CV%</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Series Temporales -->
            <div id="tab-series" class="card p-6 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-gray-800">Series Temporales por UPZ</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Indicador *</label>
                        <select id="serieIndicador">
                            <option value="">Seleccionar indicador...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Localidad</label>
                        <select id="serieLocalidad">
                            <option value="">Todas las localidades</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">UPZ *</label>
                        <select id="serieUpz">
                            <option value="">Seleccionar UPZ...</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnSerie" class="btn btn-primary w-full">
                            <i class="ti ti-trending-up"></i> Generar Serie
                        </button>
                    </div>
                </div>

                <div class="card p-4">
                    <h4 class="font-semibold mb-4">Evoluci√≥n Temporal</h4>
                    <div class="chart-medium">
                        <canvas id="chartSeries"></canvas>
                    </div>
                </div>
            </div>

            <!-- Asociaci√≥n -->
            <div id="tab-asociacion" class="card p-6 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-gray-800">An√°lisis de Asociaci√≥n entre Indicadores</h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Indicador X *</label>
                        <select id="asocIndicadorX">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Indicador Y *</label>
                        <select id="asocIndicadorY">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Localidad</label>
                        <select id="asocLocalidad">
                            <option value="">Todas las localidades</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">UPZ</label>
                        <select id="asocUpz">
                            <option value="">Todas las UPZ</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnAsociar" class="btn btn-primary w-full">
                            <i class="ti ti-chart-dots"></i> Correlacionar
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-4">Gr√°fico de Dispersi√≥n</h4>
                        <div class="chart-small">
                            <canvas id="chartAsociacion"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-4">Estad√≠sticas de Correlaci√≥n</h4>
                        <div id="resultadoAsociacion" class="space-y-3">
                            <p class="text-gray-500">Seleccione dos indicadores para analizar su correlaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √çndice de Theil -->
            <div id="tab-theil" class="card p-6 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-gray-800">√çndice de Theil - Desigualdad Territorial</h3>
                <p class="text-sm text-gray-600">Valores cercanos a 0 indican mayor igualdad entre territorios.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium mb-2">Indicador *</label>
                        <select id="theilIndicador">
                            <option value="">Seleccionar indicador...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Localidad</label>
                        <select id="theilLocalidad">
                            <option value="">Todas las localidades</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">A√±o</label>
                        <select id="theilAno">
                            <option value="">Todos los a√±os</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnTheil" class="btn btn-primary w-full">
                            <i class="ti ti-balance"></i> Calcular
                        </button>
                    </div>
                </div>

                <!-- Layout mejorado: Compacto + Scrolleable -->
                <div class="grid lg:grid-cols-4 gap-6">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-4 text-center">√çndice Calculado</h4>
                        <div class="text-center space-y-3">
                            <div class="text-4xl font-bold text-blue-600" id="theilValor">-</div>
                            <div class="text-sm text-gray-500">√çndice de Theil</div>
                            <div>
                                <span id="theilCategoria" class="px-3 py-1 rounded-full text-sm bg-gray-100">
                                    Seleccionar indicador
                                </span>
                            </div>
                            <div class="text-xs text-gray-400 bg-gray-50 p-2 rounded">
                                0 = igualdad perfecta<br>
                                >0 = mayor desigualdad
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-4 lg:col-span-3">
                        <h4 class="font-semibold mb-4">Distribuci√≥n por TODAS las UPZ (Scrolleable)</h4>
                        <div class="chart-scrollable">
                            <canvas id="chartTheil"></canvas>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">üí° Usa la barra de desplazamiento horizontal para ver todas las UPZ</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        // Variables globales
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        let charts = {};
        let metadata = {};
        let currentData = {
            localidades: [],
            upz: [],
            indicadores: [],
            a√±os: []
        };
        
        // Configuraci√≥n Chart.js
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.plugins.legend.display = true;
        Chart.defaults.plugins.legend.position = 'top';
        
        // Utility functions
        function showLoading(element) {
            if (element) element.classList.add('loading');
        }
        
        function hideLoading(element) {
            if (element) element.classList.remove('loading');
        }
        
        function showSpinner(spinnerId) {
            const spinner = $(spinnerId);
            if (spinner) spinner.classList.remove('hidden');
        }
        
        function hideSpinner(spinnerId) {
            const spinner = $(spinnerId);
            if (spinner) spinner.classList.add('hidden');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg max-w-sm text-sm`;
            toast.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="ti ti-${type === 'error' ? 'alert-circle' : type === 'success' ? 'check' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            $('#toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
        
        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                console.log(`API Call: ${endpoint}`);
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log(`API Response for ${endpoint}:`, data);
                return data;
            } catch (error) {
                console.error('API Error:', error);
                showToast(`Error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Cargar metadatos
        async function loadMetadata() {
            try {
                console.log('Loading metadata...');
                showToast('Cargando metadatos del sistema...', 'info');
                
                metadata = await apiCall('/metadatos');
                console.log('Metadata loaded:', metadata);
                
                if (metadata && metadata.indicadores && metadata.geografia) {
                    currentData.indicadores = metadata.indicadores.todos || [];
                    currentData.localidades = metadata.geografia.localidades || [];
                    currentData.upz = metadata.geografia.upz || [];
                    currentData.a√±os = metadata.temporal?.a√±os || [];
                    
                    updateKPIs();
                    populateAllSelectors();
                    showToast('Metadatos cargados correctamente', 'success');
                    
                    console.log('Current data:', currentData);
                } else {
                    throw new Error('Estructura de metadatos inv√°lida');
                }
            } catch (error) {
                console.error('Error loading metadata:', error);
                showToast('Error cargando metadatos del sistema', 'error');
            }
        }
        
        // Actualizar KPIs
        function updateKPIs() {
            if (!metadata.resumen) return;
            
            $('#kpiTotal').textContent = formatNumber(metadata.resumen.total_registros) || '0';
            $('#kpiIndicadores').textContent = formatNumber(metadata.resumen.total_indicadores) || '0';
            $('#kpiLocalidades').textContent = formatNumber(metadata.resumen.localidades) || '0';
            $('#kpiUpz').textContent = formatNumber(metadata.resumen.upz) || '0';
        }
        
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }
        
        // Poblar todos los selectores
        function populateAllSelectors() {
            console.log('Populating selectors...');
            
            // Indicadores
            populateSelect('caracIndicador', currentData.indicadores);
            populateSelect('serieIndicador', currentData.indicadores);
            populateSelect('asocIndicadorX', currentData.indicadores);
            populateSelect('asocIndicadorY', currentData.indicadores);
            populateSelect('theilIndicador', currentData.indicadores);
            
            // Localidades
            populateSelect('caracLocalidad', currentData.localidades);
            populateSelect('serieLocalidad', currentData.localidades);
            populateSelect('asocLocalidad', currentData.localidades);
            populateSelect('theilLocalidad', currentData.localidades);
            
            // A√±os
            populateSelect('theilAno', currentData.a√±os);
            
            console.log('Selectors populated successfully');
        }
        
        function populateSelect(selectId, options) {
            const select = $(selectId);
            if (!select || !options) {
                console.warn(`Cannot populate select ${selectId}:`, { select, options });
                return;
            }
            
            // Guardar la primera opci√≥n (placeholder)
            const firstOption = select.children[0];
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option.length > 50 ? 
                    option.substring(0, 47) + '...' : option;
                optionElement.title = option;
                select.appendChild(optionElement);
            });
            
            console.log(`Populated ${selectId} with ${options.length} options`);
        }
        
        // FILTROS CORREGIDOS: Funci√≥n para actualizar UPZ seg√∫n localidad
        async function updateUpzByLocalidad(localidadSelectId, upzSelectId) {
            const localidad = $(localidadSelectId).value;
            const upzSelect = $(upzSelectId);
            
            console.log(`Updating UPZ for localidad: ${localidad}`);
            
            if (!localidad) {
                // Si no hay localidad, mostrar todas las UPZ
                populateSelect(upzSelectId, currentData.upz);
                return;
            }
            
            try {
                const data = await apiCall(`/geografia/upz_por_localidad?localidad=${encodeURIComponent(localidad)}`);
                console.log(`UPZ data for ${localidad}:`, data);
                
                populateSelect(upzSelectId, data.upz || []);
                showToast(`${data.total || 0} UPZ encontradas para ${localidad}`, 'info');
            } catch (error) {
                console.error('Error updating UPZ:', error);
                populateSelect(upzSelectId, []);
                showToast('Error obteniendo UPZ de la localidad', 'error');
            }
        }
        
        // Tab management
        function initTabs() {
            $$('.tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    console.log(`Switching to tab: ${tabId}`);
                    
                    // Update buttons
                    $$('.tabs button').forEach(b => b.setAttribute('aria-selected', 'false'));
                    button.setAttribute('aria-selected', 'true');
                    
                    // Update content
                    $$('[id^="tab-"]').forEach(tab => tab.classList.add('hidden'));
                    const targetTab = $(`#tab-${tabId}`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                        // Resize charts if needed
                        setTimeout(() => {
                            Object.values(charts).forEach(chart => {
                                if (chart && typeof chart.resize === 'function') {
                                    chart.resize();
                                }
                            });
                        }, 100);
                    }
                });
            });
        }
        
        // File upload
        function initUpload() {
            $('#btnUpload').addEventListener('click', async () => {
                const fileInput = $('#fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('Seleccione un archivo Excel', 'error');
                    return;
                }
                
                if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                    showToast('Solo se permiten archivos .xlsx o .xls', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                const btn = $('#btnUpload');
                
                try {
                    btn.disabled = true;
                    showSpinner('#uploadSpinner');
                    showToast('Procesando archivo...', 'info');
                    
                    const response = await fetch('/upload/excel', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        const stats = result.estadisticas || {};
                        $('#uploadResult').innerHTML = `
                            <div class="alert alert-success">
                                <strong>‚úÖ Carga exitosa</strong><br>
                                üìÇ Archivo: ${result.archivo}<br>
                                üìä Registros cargados: ${formatNumber(stats.registros_cargados) || 0}<br>
                                üìÑ Filas procesadas: ${formatNumber(stats.filas_procesadas) || 0}<br>
                                ‚ö†Ô∏è Omitidos: ${formatNumber(stats.filas_omitidas_sin_valor) || 0}
                            </div>
                        `;
                        showToast('Archivo cargado correctamente', 'success');
                        await loadMetadata(); // Recargar metadatos
                    } else {
                        $('#uploadResult').innerHTML = `
                            <div class="alert alert-error">
                                <strong>‚ùå Error en la carga</strong><br>
                                ${result.detail || 'Error desconocido'}
                            </div>
                        `;
                        showToast('Error subiendo archivo', 'error');
                    }
                } catch (error) {
                    $('#uploadResult').innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Error de conexi√≥n</strong><br>
                            ${error.message}
                        </div>
                    `;
                    showToast('Error de conexi√≥n', 'error');
                } finally {
                    hideSpinner('#uploadSpinner');
                    btn.disabled = false;
                }
            });
        }
        
        // Caracterizaci√≥n
        function initCaracterizacion() {
            // Event listener for localidad change
            $('#caracLocalidad').addEventListener('change', () => {
                updateUpzByLocalidad('#caracLocalidad', '#caracUpz');
            });
            
            $('#btnCaracterizar').addEventListener('click', async () => {
                const indicador = $('#caracIndicador').value;
                const localidad = $('#caracLocalidad').value;
                const upz = $('#caracUpz').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    showLoading($('#tab-caracterizacion'));
                    
                    const params = new URLSearchParams({
                        indicador,
                        nivel: 'UPZ', // Siempre an√°lisis por UPZ
                        ...(localidad && { localidad }),
                        ...(upz && { upz })
                    });
                    
                    console.log('Caracterizaci√≥n params:', params.toString());
                    const data = await apiCall(`/caracterizacion?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'warning');
                        return;
                    }
                    
                    renderCaracterizacionChart(data);
                    renderCaracterizacionTable(data);
                    showToast('Caracterizaci√≥n completada', 'success');
                } catch (error) {
                    showToast('Error en caracterizaci√≥n', 'error');
                } finally {
                    hideLoading($('#tab-caracterizacion'));
                }
            });
        }
        
        function renderCaracterizacionChart(data) {
            if (charts['chartCaracterizacion']) {
                charts['chartCaracterizacion'].destroy();
            }
            
            const top10 = data.datos.slice(0, 10);
            const ctx = $('#chartCaracterizacion').getContext('2d');
            
            charts['chartCaracterizacion'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.upz.length > 15 ? d.upz.substring(0, 12) + '...' : d.upz),
                    datasets: [{
                        label: data.unidad_medida,
                        data: top10.map(d => d.promedio),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.indicador.substring(0, 50)}${data.indicador.length > 50 ? '...' : ''}`
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => top10[context[0].dataIndex].upz,
                                label: (context) => `${data.unidad_medida}: ${context.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: data.unidad_medida }
                        }
                    }
                }
            });
        }
        
        function renderCaracterizacionTable(data) {
            const tbody = $('#tableCaracterizacion tbody');
            tbody.innerHTML = data.datos.map(d => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2" title="${d.upz}">${d.upz.length > 25 ? d.upz.substring(0, 22) + '...' : d.upz}</td>
                    <td class="p-2 text-center">${d.n}</td>
                    <td class="p-2 text-right font-mono">${d.promedio}</td>
                    <td class="p-2 text-right font-mono">${d.mediana}</td>
                    <td class="p-2 text-right font-mono">${d.cv_pct}%</td>
                </tr>
            `).join('');
        }
        
        // Series Temporales
        function initSeries() {
            $('#serieLocalidad').addEventListener('change', () => {
                updateUpzByLocalidad('#serieLocalidad', '#serieUpz');
            });
            
            $('#btnSerie').addEventListener('click', async () => {
                const indicador = $('#serieIndicador').value;
                const upz = $('#serieUpz').value;
                
                if (!indicador || !upz) {
                    showToast('Seleccione indicador y UPZ', 'error');
                    return;
                }
                
                try {
                    showLoading($('#tab-series'));
                    
                    const params = new URLSearchParams({
                        indicador,
                        upz,
                        nivel: 'UPZ'
                    });
                    
                    const data = await apiCall(`/datos/series?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'warning');
                        return;
                    }
                    
                    renderSeriesChart(data);
                    showToast('Serie temporal generada', 'success');
                } catch (error) {
                    showToast('Error generando serie temporal', 'error');
                } finally {
                    hideLoading($('#tab-series'));
                }
            });
        }
        
        function renderSeriesChart(data) {
            if (charts['chartSeries']) {
                charts['chartSeries'].destroy();
            }
            
            const serie = data.serie || [];
            const ctx = $('#chartSeries').getContext('2d');
            
            charts['chartSeries'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: serie.map(s => s.a√±o),
                    datasets: [{
                        label: data.unidad_medida,
                        data: serie.map(s => s.valor),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${data.indicador.substring(0, 40)}${data.indicador.length > 40 ? '...' : ''} - ${data.upz}`
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'A√±o' }},
                        y: { title: { display: true, text: data.unidad_medida }}
                    }
                }
            });
        }
        
        // Asociaci√≥n
        function initAsociacion() {
            $('#asocLocalidad').addEventListener('change', () => {
                updateUpzByLocalidad('#asocLocalidad', '#asocUpz');
            });
            
            $('#btnAsociar').addEventListener('click', async () => {
                const indicadorX = $('#asocIndicadorX').value;
                const indicadorY = $('#asocIndicadorY').value;
                const localidad = $('#asocLocalidad').value;
                const upz = $('#asocUpz').value;
                
                if (!indicadorX || !indicadorY) {
                    showToast('Seleccione ambos indicadores', 'error');
                    return;
                }
                
                try {
                    showLoading($('#tab-asociacion'));
                    
                    const params = new URLSearchParams({
                        indicador_x: indicadorX,
                        indicador_y: indicadorY,
                        nivel: 'UPZ',
                        ...(localidad && { localidad }),
                        ...(upz && { upz })
                    });
                    
                    const data = await apiCall(`/analisis/asociacion?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'warning');
                        return;
                    }
                    
                    renderAsociacionChart(data);
                    renderAsociacionStats(data);
                    showToast('An√°lisis de asociaci√≥n completado', 'success');
                } catch (error) {
                    showToast('Error en an√°lisis de asociaci√≥n', 'error');
                } finally {
                    hideLoading($('#tab-asociacion'));
                }
            });
        }
        
        function renderAsociacionChart(data) {
            if (charts['chartAsociacion']) {
                charts['chartAsociacion'].destroy();
            }
            
            const ctx = $('#chartAsociacion').getContext('2d');
            
            charts['chartAsociacion'] = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'UPZ',
                        data: data.datos.map(d => ({ x: d.x, y: d.y })),
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (context) => data.datos[context[0].dataIndex].upz
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: data.indicador_x.substring(0, 30) + '...' }},
                        y: { title: { display: true, text: data.indicador_y.substring(0, 30) + '...' }}
                    }
                }
            });
        }
        
        function renderAsociacionStats(data) {
            const corr = data.correlacion;
            $('#resultadoAsociacion').innerHTML = `
                <div class="space-y-3 text-sm">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="font-semibold">Pearson</div>
                            <div class="text-lg font-mono">${corr.pearson_r}</div>
                            <div class="text-xs text-gray-500">p = ${corr.pearson_p}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="font-semibold">Spearman</div>
                            <div class="text-lg font-mono">${corr.spearman_rho}</div>
                            <div class="text-xs text-gray-500">p = ${corr.spearman_p}</div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="font-semibold">Interpretaci√≥n</div>
                        <div>Categor√≠a: <span class="font-semibold">${corr.categoria}</span></div>
                        <div>Significativa (p<0.05): <span class="${corr.significativa ? 'text-green-600' : 'text-red-600'} font-semibold">
                            ${corr.significativa ? 'S√≠' : 'No'}
                        </span></div>
                        <div class="text-sm text-gray-600 mt-1">UPZ analizadas: ${data.upz_comunes}</div>
                    </div>
                </div>
            `;
        }
        
        // √çndice de Theil
        function initTheil() {
            $('#theilLocalidad').addEventListener('change', () => {
                updateUpzByLocalidad('#theilLocalidad', '#theilUpz');
            });
            
            $('#btnTheil').addEventListener('click', async () => {
                const indicador = $('#theilIndicador').value;
                const localidad = $('#theilLocalidad').value;
                const a√±o = $('#theilAno').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    showLoading($('#tab-theil'));
                    
                    const params = new URLSearchParams({
                        indicador,
                        nivel: 'UPZ',
                        ...(localidad && { localidad }),
                        ...(a√±o && { a√±o })
                    });
                    
                    const data = await apiCall(`/analisis/theil?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'warning');
                        return;
                    }
                    
                    renderTheilResults(data);
                    renderTheilChart(data);
                    showToast('√çndice de Theil calculado', 'success');
                } catch (error) {
                    showToast('Error calculando √≠ndice de Theil', 'error');
                } finally {
                    hideLoading($('#tab-theil'));
                }
            });
        }
        
        function renderTheilResults(data) {
            $('#theilValor').textContent = data.indice_theil;
            
            const categoria = data.interpretacion.categoria;
            const categoriaElement = $('#theilCategoria');
            
            categoriaElement.textContent = categoria;
            categoriaElement.className = `px-3 py-1 rounded-full text-sm ${
                categoria === 'Baja' ? 'bg-green-100 text-green-800' :
                categoria === 'Moderada' ? 'bg-yellow-100 text-yellow-800' :
                'bg-red-100 text-red-800'
            }`;
        }
        
        function renderTheilChart(data) {
            if (charts['chartTheil']) {
                charts['chartTheil'].destroy();
            }
            
            // MOSTRAR TODAS LAS UPZ (no solo top 10)
            const allData = data.datos || [];
            const ctx = $('#chartTheil').getContext('2d');
            
            // Calcular ancho din√°mico
            const minWidth = Math.max(800, allData.length * 40);
            $('#chartTheil').style.width = minWidth + 'px';
            
            charts['chartTheil'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allData.map(d => d.upz.length > 12 ? d.upz.substring(0, 9) + '...' : d.upz),
                    datasets: [{
                        label: data.unidad_medida,
                        data: allData.map(d => d.valor),
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => allData[context[0].dataIndex].upz
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: data.unidad_medida }
                        }
                    }
                }
            });
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, initializing dashboard...');
            
            initTabs();
            initUpload();
            initCaracterizacion();
            initSeries();
            initAsociacion();
            initTheil();
            
            // Refresh button
            $('#btnRefresh').addEventListener('click', () => {
                location.reload();
            });
            
            // Load initial data
            await loadMetadata();
            
            console.log('Dashboard initialized successfully');
        });
    </script>
</body>
</html>
