<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fecundidad Temprana Bogot√°</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT:'#1e3a8a', 50:'#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a' },
                        accent: { DEFAULT:'#06b6d4' }
                    }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        .card { 
            background:#fff; 
            border-radius:1rem; 
            box-shadow:0 10px 20px rgba(2, 6, 23, .04), 0 2px 6px rgba(2, 6, 23, .06); 
            border:1px solid #e2e8f0; 
        }
        .btn { 
            display:inline-flex; 
            align-items:center; 
            gap:.5rem; 
            padding:.75rem 1rem; 
            border-radius:.75rem; 
            border:1px solid #cbd5e1; 
            background:#fff; 
            transition: all .2s; 
            cursor: pointer; 
            text-align: left;
            flex-direction: column;
            min-height: 3.5rem;
        }
        .btn:hover { background:#f8fafc; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-primary { background:#2563eb; border-color:#2563eb; color:#fff; }
        .btn-primary:hover { background:#1d4ed8; }
        .btn-dark { background:#1f2937; border-color:#374151; color:#fff; }
        .btn-dark:hover { background:#111827; }
        .chip { display:inline-flex; align-items:center; gap:.25rem; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; background:#e0f2fe; color:#075985; }
        .pill { display:inline-flex; align-items:center; gap:.375rem; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; background:#eef2ff; color:#3730a3; }
        .muted { color:#64748b; }
        .kpi { font-size:1.75rem; font-weight:700; }
        .grad { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 40%, #06b6d4 100%); }
        .shadow-soft { box-shadow: 0 10px 20px rgba(2,6,23,.08), 0 3px 8px rgba(2,6,23,.1); }
        .spinner { border:3px solid #e5e7eb; border-top-color:#2563eb; border-radius:999px; width:20px; height:20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .tabs button[aria-selected="true"] { background:#1e40af; color:white; border-color:#1e40af; }
        .tabs button { 
            background:#eff6ff; 
            color:#1e3a8a; 
            border:1px solid #bfdbfe; 
            padding: 1rem;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            min-height: 5rem;
        }
        .tabs button:hover {
            background:#dbeafe;
            border-color:#93c5fd;
        }
        .tab-title {
            font-weight: 600;
            font-size: 0.875rem;
        }
        .tab-description {
            font-size: 0.75rem;
            opacity: 0.8;
            line-height: 1.2;
        }
        .loading { opacity: 0.5; pointer-events: none; }
        .alert { padding: 1rem; border-radius: 0.75rem; margin: 1rem 0; }
        .alert-success { background: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .alert-error { background: #fef2f2; border: 1px solid #dc2626; color: #dc2626; }
        .alert-info { background: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        
        /* Chart container fixes */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 400px;
        }
        
        .chart-container-small {
            position: relative;
            width: 100%;
            height: 250px;
            max-height: 300px;
        }
        
        .chart-container-large {
            position: relative;
            width: 100%;
            height: 350px;
            max-height: 450px;
        }
        
        /* Scrollable chart container for Theil */
        .chart-container-scrollable {
            position: relative;
            width: 100%;
            height: 400px;
            overflow-x: auto;
            overflow-y: hidden;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: #fff;
        }
        
        .chart-container-scrollable canvas {
            min-width: 800px; /* Minimum width to show all bars */
        }
        
        /* Compact theil indicator display */
        .theil-compact {
            text-align: center;
            padding: 1.5rem;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* Responsive select fixes */
        select {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Better table responsiveness */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-responsive table {
            min-width: 100%;
            white-space: nowrap;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .chart-container, .chart-container-small, .chart-container-large {
                height: 250px;
                max-height: 300px;
            }
            
            .chart-container-scrollable {
                height: 300px;
            }
            
            .tabs {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .tabs button {
                min-height: 4rem;
                padding: 0.75rem 0.5rem;
            }
            
            .tab-title {
                font-size: 0.75rem;
            }
            
            .tab-description {
                font-size: 0.625rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .lg\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .lg\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 640px) {
            .tabs {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Header -->
    <header class="grad text-white">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-xl sm:text-2xl md:text-3xl font-bold tracking-tight">
                        üèõÔ∏è Exploraci√≥n Determinantes Fecundidad Temprana
                    </h1>
                    <p class="mt-1 text-slate-100/90 text-sm sm:text-base">
                        Bogot√° D.C. ‚Ä¢ An√°lisis territorial por UPZ (10-14, 15-19)
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btnRefresh" class="btn btn-dark shadow-soft text-sm">
                        <i class="ti ti-refresh"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-4 sm:py-6 space-y-6 sm:space-y-8">
        <!-- KPIs -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
            <div class="card p-3 sm:p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-xs sm:text-sm">Registros</span>
                    <span class="pill text-xs">Total</span>
                </div>
                <div id="kpiTotal" class="text-lg sm:text-xl lg:text-2xl font-bold mt-1">-</div>
                <div class="muted text-xs">Datos cargados</div>
            </div>
            <div class="card p-3 sm:p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-xs sm:text-sm">Indicadores</span>
                    <span class="pill text-xs">√önicos</span>
                </div>
                <div id="kpiIndicadores" class="text-lg sm:text-xl lg:text-2xl font-bold mt-1">-</div>
                <div class="muted text-xs">Variables disponibles</div>
            </div>
            <div class="card p-3 sm:p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-xs sm:text-sm">Localidades</span>
                    <span class="pill text-xs">Cobertura</span>
                </div>
                <div id="kpiLocalidades" class="text-lg sm:text-xl lg:text-2xl font-bold mt-1">-</div>
                <div class="muted text-xs">Unidades admin.</div>
            </div>
            <div class="card p-3 sm:p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-xs sm:text-sm">UPZ</span>
                    <span class="pill text-xs">Cobertura</span>
                </div>
                <div id="kpiUpz" class="text-lg sm:text-xl lg:text-2xl font-bold mt-1">-</div>
                <div class="muted text-xs">Unidades territoriales</div>
            </div>
        </section>

        <!-- Upload Section -->
        <section class="card p-4 sm:p-5">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-primary-800 flex items-center gap-2 text-sm sm:text-base">
                    <i class="ti ti-upload"></i> Carga de Datos
                </h2>
                <span class="chip text-xs">POST /upload/excel</span>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Archivo Excel (.xlsx, .xls)</label>
                    <input id="fileInput" type="file" accept=".xlsx,.xls" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm">
                </div>
                <div class="flex items-end gap-2">
                    <button id="btnUpload" class="btn btn-primary text-sm">
                        <i class="ti ti-cloud-upload"></i> Subir Archivo
                    </button>
                    <div id="uploadSpinner" class="hidden spinner"></div>
                </div>
            </div>
            <div id="uploadResult" class="mt-4"></div>
        </section>

        <!-- Analysis Tabs with Corrected Order -->
        <section class="space-y-4">
            <div class="tabs">
                <button class="btn" data-tab="caracterizacion" aria-selected="true">
                    <i class="ti ti-chart-bar text-xl"></i>
                    <div class="tab-title">Caracterizaci√≥n</div>
                    <div class="tab-description">Estad√≠sticas por UPZ y localidad</div>
                </button>
                <button class="btn" data-tab="series">
                    <i class="ti ti-trending-up text-xl"></i>
                    <div class="tab-title">Series</div>
                    <div class="tab-description">Evoluci√≥n temporal por UPZ</div>
                </button>
                <button class="btn" data-tab="asociacion">
                    <i class="ti ti-chart-dots text-xl"></i>
                    <div class="tab-title">Asociaci√≥n</div>
                    <div class="tab-description">Correlaciones entre variables</div>
                </button>
                <button class="btn" data-tab="theil">
                    <i class="ti ti-balance text-xl"></i>
                    <div class="tab-title">Desigualdad</div>
                    <div class="tab-description">√çndice de Theil territorial</div>
                </button>
            </div>

            <!-- Caracterizaci√≥n -->
            <div id="tab-caracterizacion" class="card p-4 sm:p-5 space-y-4">
                <h3 class="text-lg font-semibold text-primary-800">Caracterizaci√≥n Territorial</h3>
                <p class="text-sm text-gray-600">Analiza estad√≠sticas descriptivas de indicadores por UPZ y localidad: promedios, medianas, desviaciones y coeficientes de variaci√≥n.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="lg:col-span-2">
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="caracIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="caracNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" id="caracTerritorioLabel">Localidad</label>
                        <select id="caracTerritorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2 lg:col-span-1 flex items-end">
                        <button id="btnCaracterizar" class="btn btn-primary w-full text-sm">
                            <i class="ti ti-chart-bar"></i> Analizar
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-sm sm:text-base">Top 10 UPZ</h4>
                            <button id="btnDownloadCarac" class="btn text-xs">
                                <i class="ti ti-download"></i> CSV
                            </button>
                        </div>
                        <div class="chart-container-small">
                            <canvas id="chartCaracterizacion"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3 text-sm sm:text-base">Estad√≠sticas Descriptivas</h4>
                        <div class="table-responsive max-h-64 overflow-auto">
                            <table id="tableCaracterizacion" class="w-full text-xs sm:text-sm">
                                <thead class="bg-primary-50 text-primary-900 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left">UPZ</th>
                                        <th class="p-2 text-right">N</th>
                                        <th class="p-2 text-right">Promedio</th>
                                        <th class="p-2 text-right">Mediana</th>
                                        <th class="p-2 text-right">CV%</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Series Temporales - Moved after Caracterizaci√≥n -->
            <div id="tab-series" class="card p-4 sm:p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">Series Temporales</h3>
                <p class="text-sm text-gray-600">Muestra la evoluci√≥n temporal de un indicador en una UPZ espec√≠fica, identificando tendencias y patrones.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="serieIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" id="serieTerritorioLabel">Localidad</label>
                        <select id="serieTerritorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="serieNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnSerie" class="btn btn-primary w-full text-sm">
                            <i class="ti ti-trending-up"></i> Serie
                        </button>
                    </div>
                </div>

                <div class="card p-4">
                    <h4 class="font-semibold mb-3 text-sm sm:text-base">Evoluci√≥n Temporal por Cohortes</h4>
                    <div class="chart-container">
                        <canvas id="chartSeries"></canvas>
                    </div>
                </div>
            </div>

            <!-- Asociaci√≥n -->
            <div id="tab-asociacion" class="card p-4 sm:p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">An√°lisis de Asociaci√≥n</h3>
                <p class="text-sm text-gray-600">Calcula correlaciones de Pearson y Spearman entre dos indicadores para identificar posibles relaciones estad√≠sticas.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador X</label>
                        <select id="asocIndicadorX" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador Y</label>
                        <select id="asocIndicadorY" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="asocNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" id="asocTerritorioLabel">Localidad</label>
                        <select id="asocTerritorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnAsociar" class="btn btn-primary w-full text-sm">
                            <i class="ti ti-chart-dots"></i> Correlacionar
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3 text-sm sm:text-base">Dispersi√≥n</h4>
                        <div class="chart-container-small">
                            <canvas id="chartAsociacion"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3 text-sm sm:text-base">Estad√≠sticas de Correlaci√≥n</h4>
                        <div id="resultadoAsociacion" class="space-y-3 text-sm">
                            <p class="text-gray-500">Seleccione dos indicadores para ver la correlaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theil - Improved Layout -->
            <div id="tab-theil" class="card p-4 sm:p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">√çndice de Theil - Desigualdad Territorial</h3>
                <p class="text-sm text-gray-600">Mide el grado de desigualdad territorial de un indicador. Valores cercanos a 0 indican mayor igualdad entre UPZ.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="theilIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="theilNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">A√±o</label>
                        <select id="theilAno" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" id="theilTerritorioLabel">Localidad</label>
                        <select id="theilTerritorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnTheil" class="btn btn-primary w-full text-sm">
                            <i class="ti ti-balance"></i> Calcular
                        </button>
                    </div>
                </div>

                <!-- Improved Layout: Compact indicator + Full chart -->
                <div class="grid lg:grid-cols-3 gap-4">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3 text-sm sm:text-base">√çndice de Desigualdad</h4>
                        <div id="theilResultado" class="theil-compact">
                            <div class="text-3xl sm:text-4xl font-bold text-gray-400" id="theilValor">-</div>
                            <div class="text-sm text-gray-500 mt-2">√çndice de Theil</div>
                            <div class="mt-3">
                                <span id="theilCategoria" class="px-3 py-1 rounded-full text-sm bg-gray-100">
                                    Seleccionar indicador
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded mt-3">
                                <strong>Interpretaci√≥n:</strong> 0 = igualdad perfecta, >0 = mayor desigualdad
                            </div>
                        </div>
                    </div>
                    <div class="card p-4 lg:col-span-2">
                        <h4 class="font-semibold mb-3 text-sm sm:text-base">Distribuci√≥n por UPZ (Todas las unidades)</h4>
                        <div class="chart-container-scrollable">
                            <canvas id="chartTheil"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        // Utility functions
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        let charts = {};
        let metadata = {};
        
        // Chart.js default configuration with responsive fixes
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.plugins.legend.display = true;
        Chart.defaults.plugins.legend.position = 'top';
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.legend.labels.padding = 15;
        Chart.defaults.plugins.legend.labels.font = { size: 12 };
        
        // Custom chart creation function with responsive settings
        function createResponsiveChart(canvasId, config) {
            const canvas = $(canvasId);
            if (!canvas) return null;
            
            // Destroy existing chart
            if (charts[canvasId]) {
                charts[canvasId].destroy();
                delete charts[canvasId];
            }
            
            // Enhanced responsive configuration
            const responsiveConfig = {
                ...config,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        ...config.options?.scales,
                        x: {
                            ...config.options?.scales?.x,
                            ticks: {
                                ...config.options?.scales?.x?.ticks,
                                maxRotation: window.innerWidth < 768 ? 90 : 45,
                                minRotation: window.innerWidth < 768 ? 45 : 0,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                }
                            }
                        },
                        y: {
                            ...config.options?.scales?.y,
                            ticks: {
                                ...config.options?.scales?.y?.ticks,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                }
                            }
                        }
                    },
                    plugins: {
                        ...config.options?.plugins,
                        legend: {
                            display: true,
                            position: window.innerWidth < 768 ? 'bottom' : 'top',
                            labels: {
                                usePointStyle: true,
                                padding: window.innerWidth < 768 ? 10 : 15,
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            titleFont: {
                                size: window.innerWidth < 768 ? 12 : 14
                            },
                            bodyFont: {
                                size: window.innerWidth < 768 ? 11 : 13
                            }
                        }
                    },
                    ...config.options
                }
            };
            
            try {
                const chart = new Chart(canvas, responsiveConfig);
                charts[canvasId] = chart;
                return chart;
            } catch (error) {
                console.error('Error creating chart:', error);
                showToast('Error creando gr√°fica', 'error');
                return null;
            }
        }
        
        // Resize handler for charts
        function handleResize() {
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        }
        
        // Add resize listener
        window.addEventListener('resize', debounce(handleResize, 250));
        
        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg max-w-sm animate-fade-in text-sm`;
            toast.textContent = message;
            
            $('#toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
        
        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast(`Error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Load metadata
        async function loadMetadata() {
            try {
                metadata = await apiCall('/metadatos');
                updateKPIs();
                populateSelectors();
                showToast('Metadatos cargados correctamente', 'success');
            } catch (error) {
                showToast('Error cargando metadatos', 'error');
            }
        }
        
        // Update KPIs
        function updateKPIs() {
            $('#kpiTotal').textContent = formatNumber(metadata.resumen?.total_registros) || '-';
            $('#kpiIndicadores').textContent = formatNumber(metadata.resumen?.total_indicadores) || '-';
            $('#kpiLocalidades').textContent = formatNumber(metadata.resumen?.localidades) || '-';
            $('#kpiUpz').textContent = formatNumber(metadata.resumen?.upz) || '-';
        }
        
        // Format large numbers
        function formatNumber(num) {
            if (!num) return '-';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }
        
        // Populate selectors with better text handling
        function populateSelectors() {
            const indicadores = metadata.indicadores?.todos || [];
            const fecundidadIndicadores = metadata.indicadores?.fecundidad || [];
            const a√±os = metadata.temporal?.a√±os || [];
            const localidades = metadata.geografia?.localidades || [];
            const upz = metadata.geografia?.upz || [];
            
            // Indicadores (todos)
            populateSelect('caracIndicador', indicadores, true);
            populateSelect('asocIndicadorX', indicadores, true);
            populateSelect('asocIndicadorY', indicadores, true);
            populateSelect('theilIndicador', indicadores, true);
            populateSelect('serieIndicador', indicadores, true);
            
            // A√±os
            populateSelect('theilAno', a√±os);
            
            // Territorios iniciales (localidades por defecto)
            populateSelect('caracTerritorio', localidades);
            populateSelect('asocTerritorio', localidades);
            populateSelect('theilTerritorio', localidades);
            populateSelect('serieTerritorio', localidades);
        }
        
        function populateSelect(selectId, options, truncate = false) {
            const select = $(`#${selectId}`);
            if (!select) return;
            
            // Keep first option (placeholder)
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                
                // Truncate long text for better display
                let displayText = option;
                if (truncate && option.length > 50) {
                    displayText = option.substring(0, 47) + '...';
                }
                
                optionElement.textContent = displayText;
                optionElement.title = option; // Full text in tooltip
                select.appendChild(optionElement);
            });
        }
        
        // IMPROVED: Update UPZ/Localidad based on level selection
        function updateTerritorioForLevel(levelSelectId, territorioSelectId, labelId) {
            const nivel = $(`#${levelSelectId}`).value;
            const label = $(`#${labelId}`);
            
            if (nivel === 'LOCALIDAD') {
                label.textContent = 'Localidad';
                populateSelect(territorioSelectId, metadata.geografia?.localidades || []);
            } else {
                label.textContent = 'UPZ';
                populateSelect(territorioSelectId, metadata.geografia?.upz || []);
            }
        }
        
        // IMPROVED: Filter UPZ by selected localidad when nivel is UPZ
        async function filterTerritorioBySelection(levelSelectId, territorioSelectId) {
            const nivel = $(`#${levelSelectId}`).value;
            const territorio = $(`#${territorioSelectId}`).value;
            
            // Si est√° en modo UPZ y se seleccion√≥ una localidad espec√≠fica, filtrar UPZ
            if (nivel === 'UPZ' && territorio) {
                try {
                    const data = await apiCall(`/geografia/upz_por_localidad?localidad=${encodeURIComponent(territorio)}`);
                    populateSelect(territorioSelectId, data.upz || []);
                } catch (error) {
                    console.error('Error filtering UPZ:', error);
                    populateSelect(territorioSelectId, []);
                }
            }
        }
        
        // Tab management
        function initTabs() {
            $$('.tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Update buttons
                    $$('.tabs button').forEach(b => b.setAttribute('aria-selected', 'false'));
                    button.setAttribute('aria-selected', 'true');
                    
                    // Update content
                    $$('[id^="tab-"]').forEach(tab => tab.classList.add('hidden'));
                    const targetTab = $(`#tab-${tabId}`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                        // Trigger resize for charts in the newly visible tab
                        setTimeout(handleResize, 100);
                    }
                });
            });
        }
        
        // File upload with better error handling
        function initUpload() {
            $('#btnUpload').addEventListener('click', async () => {
                const fileInput = $('#fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('Seleccione un archivo', 'error');
                    return;
                }
                
                // Validate file type
                if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                    showToast('Solo se permiten archivos .xlsx o .xls', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                const spinner = $('#uploadSpinner');
                const btn = $('#btnUpload');
                
                try {
                    spinner.classList.remove('hidden');
                    btn.disabled = true;
                    
                    showToast('Procesando archivo...', 'info');
                    
                    const response = await fetch('/upload/excel', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        const stats = result.estadisticas || {};
                        $('#uploadResult').innerHTML = `
                            <div class="alert alert-success">
                                <strong>‚úÖ Carga exitosa</strong><br>
                                üìÇ Archivo: ${result.archivo}<br>
                                üìä Registros cargados: ${formatNumber(stats.registros_cargados) || 0}<br>
                                üìÑ Filas procesadas: ${formatNumber(stats.filas_procesadas) || 0}<br>
                                ‚ö†Ô∏è Omitidos sin valor: ${formatNumber(stats.omitidos_sin_valor) || 0}<br>
                                ‚ùå Errores: ${formatNumber(stats.errores) || 0}
                            </div>
                        `;
                        showToast('Archivo cargado correctamente', 'success');
                        await loadMetadata();
                    } else {
                        const errorDetails = result.detail || 'Error desconocido';
                        $('#uploadResult').innerHTML = `
                            <div class="alert alert-error">
                                <strong>‚ùå Error en la carga</strong><br>
                                ${errorDetails}
                                ${result.columnas_disponibles ? `<br><br><strong>Columnas encontradas:</strong><br>${result.columnas_disponibles.join(', ')}` : ''}
                            </div>
                        `;
                        showToast('Error subiendo archivo', 'error');
                    }
                } catch (error) {
                    $('#uploadResult').innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Error de conexi√≥n</strong><br>
                            ${error.message}
                        </div>
                    `;
                    showToast('Error de conexi√≥n', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    btn.disabled = false;
                }
            });
        }
        
        // FIXED: Caracterizaci√≥n with proper territory filtering
        function initCaracterizacion() {
            // Level change handler
            $('#caracNivel').addEventListener('change', () => {
                updateTerritorioForLevel('caracNivel', 'caracTerritorio', 'caracTerritorioLabel');
            });
            
            $('#btnCaracterizar').addEventListener('click', async () => {
                const indicador = $('#caracIndicador').value;
                const nivel = $('#caracNivel').value;
                const territorio = $('#caracTerritorio').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        nivel,
                        ...(territorio && { [nivel.toLowerCase()]: territorio })
                    });
                    
                    const data = await apiCall(`/caracterizacion?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderCaracterizacionChart(data);
                    renderCaracterizacionTable(data);
                    showToast('Caracterizaci√≥n completada', 'success');
                } catch (error) {
                    showToast('Error en caracterizaci√≥n', 'error');
                }
            });
        }
        
        function renderCaracterizacionChart(data) {
            const top10 = data.datos.slice(0, 10);
            
            const config = {
                type: 'bar',
                data: {
                    labels: top10.map(d => {
                        // Truncate long UPZ names
                        return d.upz.length > 15 ? 
                            d.upz.substring(0, 12) + '...' : 
                            d.upz;
                    }),
                    datasets: [{
                        label: `${data.indicador.length > 30 ? data.indicador.substring(0, 27) + '...' : data.indicador}`,
                        data: top10.map(d => d.promedio),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    // Show full UPZ name in tooltip
                                    return top10[context[0].dataIndex].upz;
                                },
                                label: (context) => {
                                    return `${data.unidad_medida}: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: data.unidad_medida
                            }
                        }
                    }
                }
            };
            
            createResponsiveChart('#chartCaracterizacion', config);
        }
        
        function renderCaracterizacionTable(data) {
            const tbody = $('#tableCaracterizacion tbody');
            tbody.innerHTML = data.datos.map(d => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2" title="${d.upz}">${d.upz.length > 20 ? d.upz.substring(0, 17) + '...' : d.upz}</td>
                    <td class="p-2 text-right">${d.n}</td>
                    <td class="p-2 text-right">${d.promedio}</td>
                    <td class="p-2 text-right">${d.mediana}</td>
                    <td class="p-2 text-right">${d.cv_pct}%</td>
                </tr>
            `).join('');
        }
        
        // FIXED: Series Temporales with proper territory filtering
        function initSeries() {
            // Update territory based on level selection
            $('#serieNivel').addEventListener('change', () => {
                updateTerritorioForLevel('serieNivel', 'serieTerritorio', 'serieTerritorioLabel');
            });
            
            $('#btnSerie').addEventListener('click', async () => {
                const indicador = $('#serieIndicador').value;
                const territorio = $('#serieTerritorio').value;
                const nivel = $('#serieNivel').value;
                
                if (!indicador || !territorio) {
                    showToast('Seleccione indicador y territorio', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        upz: territorio,
                        nivel
                    });
                    
                    const data = await apiCall(`/datos/series?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderSeriesChart(data, { indicador, territorio });
                    showToast('Serie temporal generada', 'success');
                } catch (error) {
                    showToast('Error generando serie temporal', 'error');
                }
            });
        }
        
        function renderSeriesChart(data, metadata) {
            const serie = data.serie || [];
            
            const config = {
                type: 'line',
                data: {
                    labels: serie.map(s => s.a√±o),
                    datasets: [{
                        label: metadata.indicador.length > 30 ? 
                            metadata.indicador.substring(0, 27) + '...' : 
                            metadata.indicador,
                        data: serie.map(s => s.valor),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        pointRadius: window.innerWidth < 768 ? 3 : 4,
                        pointHoverRadius: window.innerWidth < 768 ? 5 : 6
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: window.innerWidth < 768 ? 
                                `${metadata.territorio}` : 
                                `${metadata.indicador} - ${metadata.territorio}`,
                            font: {
                                size: window.innerWidth < 768 ? 12 : 14
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: 'A√±o' 
                            }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: data.unidad_medida || 'Valor'
                            }
                        }
                    }
                }
            };
            
            createResponsiveChart('#chartSeries', config);
        }
        
        // FIXED: Asociaci√≥n with proper territory filtering
        function initAsociacion() {
            // Level change handler
            $('#asocNivel').addEventListener('change', () => {
                updateTerritorioForLevel('asocNivel', 'asocTerritorio', 'asocTerritorioLabel');
            });
            
            $('#btnAsociar').addEventListener('click', async () => {
                const indicadorX = $('#asocIndicadorX').value;
                const indicadorY = $('#asocIndicadorY').value;
                const nivel = $('#asocNivel').value;
                const territorio = $('#asocTerritorio').value;
                
                if (!indicadorX || !indicadorY) {
                    showToast('Seleccione ambos indicadores', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador_x: indicadorX,
                        indicador_y: indicadorY,
                        nivel,
                        ...(territorio && { [nivel.toLowerCase()]: territorio })
                    });
                    
                    const data = await apiCall(`/analisis/asociacion?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderAsociacionChart(data);
                    renderAsociacionStats(data);
                    showToast('An√°lisis de asociaci√≥n completado', 'success');
                } catch (error) {
                    showToast('Error en an√°lisis de asociaci√≥n', 'error');
                }
            });
        }
        
        function renderAsociacionChart(data) {
            const config = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'UPZ',
                        data: data.datos.map(d => ({ x: d.x, y: d.y })),
                        backgroundColor: '#06b6d4',
                        borderColor: '#0891b2',
                        pointRadius: window.innerWidth < 768 ? 4 : 5,
                        pointHoverRadius: window.innerWidth < 768 ? 6 : 8
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    return data.datos[context[0].dataIndex].upz;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: data.indicador_x.length > 25 ? 
                                    data.indicador_x.substring(0, 22) + '...' : 
                                    data.indicador_x
                            }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: data.indicador_y.length > 25 ? 
                                    data.indicador_y.substring(0, 22) + '...' : 
                                    data.indicador_y
                            }
                        }
                    }
                }
            };
            
            createResponsiveChart('#chartAsociacion', config);
        }
        
        function renderAsociacionStats(data) {
            const container = $('#resultadoAsociacion');
            const corr = data.correlacion;
            
            container.innerHTML = `
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Correlaci√≥n de Pearson:</span>
                        <span class="font-mono">${corr.pearson_r} (p=${corr.pearson_p})</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Correlaci√≥n de Spearman:</span>
                        <span class="font-mono">${corr.spearman_rho} (p=${corr.spearman_p})</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Categor√≠a:</span>
                        <span class="font-semibold">${corr.categoria}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Significativa (p<0.05):</span>
                        <span class="${corr.significativa ? 'text-green-600' : 'text-red-600'} font-semibold">
                            ${corr.significativa ? 'S√≠' : 'No'}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span>UPZ comunes:</span>
                        <span>${data.upz_comunes}</span>
                    </div>
                </div>
            `;
        }
        
        // IMPROVED: Theil Index with better layout and scrollable chart
        function initTheil() {
            // Level change handler
            $('#theilNivel').addEventListener('change', () => {
                updateTerritorioForLevel('theilNivel', 'theilTerritorio', 'theilTerritorioLabel');
            });
            
            $('#btnTheil').addEventListener('click', async () => {
                const indicador = $('#theilIndicador').value;
                const nivel = $('#theilNivel').value;
                const a√±o = $('#theilAno').value;
                const territorio = $('#theilTerritorio').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        nivel,
                        ...(a√±o && { a√±o }),
                        ...(territorio && { [nivel.toLowerCase()]: territorio })
                    });
                    
                    const data = await apiCall(`/analisis/theil?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderTheilResults(data);
                    renderTheilChart(data);
                    showToast('√çndice de Theil calculado', 'success');
                } catch (error) {
                    showToast('Error calculando √≠ndice de Theil', 'error');
                }
            });
        }
        
        function renderTheilResults(data) {
            $('#theilValor').textContent = data.indice_theil;
            
            const categoria = data.interpretacion.categoria;
            const categoriaElement = $('#theilCategoria');
            
            categoriaElement.textContent = categoria;
            categoriaElement.className = `px-3 py-1 rounded-full text-sm ${
                categoria === 'Baja' ? 'bg-green-100 text-green-800' :
                categoria === 'Moderada' ? 'bg-yellow-100 text-yellow-800' :
                'bg-red-100 text-red-800'
            }`;
        }
        
        function renderTheilChart(data) {
            // Show ALL UPZ instead of just top 10
            const allData = data.datos || [];
            
            const config = {
                type: 'bar',
                data: {
                    labels: allData.map(d => {
                        return d.upz.length > 12 ? 
                            d.upz.substring(0, 9) + '...' : 
                            d.upz;
                    }),
                    datasets: [{
                        label: `Valor (${data.unidad_medida})`,
                        data: allData.map(d => d.valor),
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    return allData[context[0].dataIndex].upz;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: data.unidad_medida
                            }
                        }
                    },
                    // Enable scrolling by setting a minimum width
                    responsive: false,
                    maintainAspectRatio: false
                }
            };
            
            // Set dynamic width based on number of UPZ
            const canvas = $('#chartTheil');
            const container = canvas.parentElement;
            const minWidth = Math.max(800, allData.length * 40); // 40px per bar minimum
            canvas.style.width = `${minWidth}px`;
            canvas.width = minWidth;
            
            createResponsiveChart('#chartTheil', config);
        }
        
        // CSV Download placeholder
        function initDownloads() {
            $('#btnDownloadCarac').addEventListener('click', () => {
                showToast('Funci√≥n de descarga en desarrollo', 'info');
            });
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            initUpload();
            initCaracterizacion();
            initSeries();
            initAsociacion();
            initTheil();
            initDownloads();
            
            // Refresh button
            $('#btnRefresh').addEventListener('click', loadMetadata);
            
            // Load initial data
            loadMetadata();
        });
    </script>
</body>
</html>
