<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Observatorio · Fecundidad Temprana</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { DEFAULT:'#1e3a8a', 50:'#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a' },
            accent: { DEFAULT:'#06b6d4' }
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 10px 20px rgba(2, 6, 23, .04), 0 2px 6px rgba(2, 6, 23, .06); border:1px solid #e2e8f0; }
    .btn  { display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .85rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; transition: all .15s; }
    .btn:hover { background:#f8fafc; transform: translateY(-1px); }
    .btn-primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn-primary:hover { background:#1d4ed8; }
    .chip { display:inline-flex; align-items:center; gap:.25rem; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; background:#e0f2fe; color:#075985; }
    .pill { display:inline-flex; align-items:center; gap:.375rem; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; background:#eef2ff; color:#3730a3; }
    .muted { color:#64748b; }
    .kpi { font-size:1.75rem; font-weight:700; }
    .grad { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 40%, #06b6d4 100%); }
    .shadow-soft { box-shadow: 0 10px 20px rgba(2,6,23,.08), 0 3px 8px rgba(2,6,23,.1); }
    .spinner{ border:3px solid #e5e7eb; border-top-color:#2563eb; border-radius:999px; width:20px; height:20px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tabs button[aria-selected="true"]{ background:#1e40af; color:white; }
    .tabs button{ background:#eff6ff; color:#1e3a8a; border:1px solid #bfdbfe; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Hero -->
  <header class="grad text-white">
    <div class="max-w-7xl mx-auto px-4 py-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Observatorio de Fecundidad Temprana — Bogotá D.C.</h1>
        <p class="mt-1 text-slate-100/90">Análisis por territorio, periodo y <b>cohortes (10–14, 15–19)</b>. Incluye caracterización, asociación, brechas y tendencias.</p>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn btn-primary shadow-soft" href="/docs" target="_blank"><i class="ti ti-api"></i> OpenAPI</a>
        <button id="btnRefMeta" class="btn shadow-soft"><i class="ti ti-refresh"></i> Refrescar</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">
    <!-- KPIs -->
    <section class="grid md:grid-cols-4 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between"><span class="muted text-sm">Registros</span><span class="pill">/metadatos</span></div>
        <div id="kTotal" class="kpi mt-1">—</div>
        <div class="muted text-xs">Total registros cargados</div>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between"><span class="muted text-sm">Indicadores</span><span class="pill">Únicos</span></div>
        <div id="kIndicadores" class="kpi mt-1">—</div>
        <div class="muted text-xs">Variables disponibles</div>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between"><span class="muted text-sm">Localidades</span><span class="pill">Cobertura</span></div>
        <div id="kLocs" class="kpi mt-1">—</div>
        <div class="muted text-xs">Cobertura territorial</div>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between"><span class="muted text-sm">UPZ</span><span class="pill">Cobertura</span></div>
        <div id="kUpz" class="kpi mt-1">—</div>
        <div class="muted text-xs">Cobertura territorial</div>
      </div>
    </section>

    <!-- Carga -->
    <section class="card p-5">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-primary-800 flex items-center gap-2"><i class="ti ti-upload"></i> Carga de datos</h2>
        <span class="chip">POST /upload/excel</span>
      </div>
      <div class="mt-3 grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm">Archivo consolidado (.xlsx)</label>
          <input id="file" type="file" accept=".xlsx,.xls" class="mt-1 w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
        </div>
        <div class="flex items-end gap-2">
          <button class="btn btn-primary" onclick="upload()"><i class="ti ti-cloud-upload"></i> Subir y procesar</button>
          <div id="uploadSpin" class="hidden spinner"></div>
        </div>
      </div>
      <pre id="uploadOut" class="mt-3 text-xs whitespace-pre-wrap muted"></pre>
    </section>

    <!-- Tabs de objetivos -->
    <section class="space-y-4">
      <div class="tabs flex flex-wrap gap-2">
        <button class="btn" data-tab="obj1" aria-selected="true">Objetivo 1 · Caracterización</button>
        <button class="btn" data-tab="obj2">Objetivo 2 · Asociación</button>
        <button class="btn" data-tab="obj3">Objetivo 3 · Brechas (cohortes)</button>
        <button class="btn" data-tab="obj4">Objetivo 4 · Tendencias</button>
      </div>

      <!-- OBJ 1: Caracterización -->
      <div id="obj1" class="card p-5 space-y-4">
        <div class="grid md:grid-cols-5 gap-3">
          <div>
            <label class="text-sm">Indicador</label>
            <select id="selIndicador" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-sm">Nivel</label>
            <select id="selNivel" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option>LOCALIDAD</option><option>UPZ</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Cohorte</label>
            <select id="selCohorte" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option value="">Ambas</option><option>10-14</option><option>15-19</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Año (opcional)</label>
            <select id="selAnio" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div class="flex items-end">
            <button class="btn btn-primary w-full" onclick="runCaracterizacion()"><i class="ti ti-sparkles"></i> Caracterizar</button>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Top por promedio</h3>
              <button class="btn" onclick="downloadCSV('carac')"><i class="ti ti-download"></i> CSV</button>
            </div>
            <canvas id="chartCarac" height="220"></canvas>
          </div>
          <div class="card p-4 overflow-auto">
            <h3 class="font-semibold">Resumen estadístico por territorio</h3>
            <table class="w-full text-sm border-collapse" id="tblCarac">
              <thead class="bg-primary-50 text-primary-900">
                <tr><th class="p-2 border">Territorio</th><th class="p-2 border">n</th><th class="p-2 border">Prom.</th><th class="p-2 border">Mediana</th><th class="p-2 border">Q1</th><th class="p-2 border">Q3</th><th class="p-2 border">Mín</th><th class="p-2 border">Máx</th><th class="p-2 border">DE</th><th class="p-2 border">CV%</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- OBJ 2: Asociación -->
      <div id="obj2" class="card p-5 space-y-4 hidden">
        <div class="grid md:grid-cols-5 gap-3">
          <div>
            <label class="text-sm">Indicador objetivo (fecundidad)</label>
            <select id="selIndObj" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-sm">Nivel</label>
            <select id="selNivelAsoc" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option>LOCALIDAD</option><option>UPZ</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Cohorte</label>
            <select id="selCohorteAsoc" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option value="">Ambas</option><option>10-14</option><option>15-19</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Año (opcional)</label>
            <select id="selAnioAsoc" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-sm">Top</label>
            <input id="inpTop" type="number" min="3" max="50" value="10" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-4">
          <div class="card p-4 overflow-auto">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Ranking por |r (Pearson)|</h3>
              <button class="btn" onclick="downloadCSV('asoc')"><i class="ti ti-download"></i> CSV</button>
            </div>
            <table class="w-full text-sm border-collapse" id="tblAsoc">
              <thead class="bg-primary-50 text-primary-900"><tr><th class="p-2 border">Indicador comparado</th><th class="p-2 border">Territorios</th><th class="p-2 border">Pearson r (p)</th><th class="p-2 border">Spearman ρ (p)</th><th class="p-2 border">Dispersión</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card p-4">
            <h3 class="font-semibold">Dispersión territorial</h3>
            <canvas id="chartDisp" height="220"></canvas>
            <p class="text-xs muted mt-1" id="dispMeta">Seleccione una fila para visualizar.</p>
          </div>
        </div>
      </div>

      <!-- OBJ 3: Brechas -->
      <div id="obj3" class="card p-5 space-y-4 hidden">
        <div class="grid md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm">Indicador</label>
            <select id="selIndicadorBrecha" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-sm">Nivel</label>
            <select id="selNivelBrecha" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option>LOCALIDAD</option><option>UPZ</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Año (opcional)</label>
            <select id="selAnioBrecha" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div class="flex items-end">
            <button class="btn btn-primary w-full" onclick="runBrechas()"><i class="ti ti-arrows-diff"></i> Calcular brechas</button>
          </div>
        </div>
        <div class="grid lg:grid-cols-2 gap-4">
          <div class="card p-4">
            <h3 class="font-semibold">Brecha (15–19 – 10–14)</h3>
            <canvas id="chartBrecha" height="220"></canvas>
          </div>
          <div class="card p-4 overflow-auto">
            <h3 class="font-semibold">Detalle</h3>
            <table class="w-full text-sm border-collapse" id="tblBrecha">
              <thead class="bg-primary-50 text-primary-900"><tr><th class="p-2 border">Territorio</th><th class="p-2 border">Prom 10–14</th><th class="p-2 border">Prom 15–19</th><th class="p-2 border">Brecha abs</th><th class="p-2 border">Brecha rel</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- OBJ 4: Tendencias -->
      <div id="obj4" class="card p-5 space-y-4 hidden">
        <div class="grid md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm">Indicador</label>
            <select id="selIndSerie" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div>
            <label class="text-sm">Nivel</label>
            <select id="selNivelSerie" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white">
              <option>LOCALIDAD</option><option>UPZ</option>
            </select>
          </div>
          <div>
            <label class="text-sm">Territorio</label>
            <select id="selTerrSerie" class="w-full px-3 py-2 rounded-lg border border-slate-300 bg-white"></select>
          </div>
          <div class="flex items-end">
            <button class="btn btn-primary w-full" onclick="runSerie()"><i class="ti ti-trending-up"></i> Ver serie</button>
          </div>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold">Serie temporal por cohortes</h3>
          <canvas id="chartSerie" height="220"></canvas>
        </div>
      </div>
    </section>
  </main>

  <div class="fixed right-4 bottom-4 space-y-2" id="toasts"></div>

<script>
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

function toast(msg, ok=true){
  const div=document.createElement('div');
  div.className='px-3 py-2 rounded-xl shadow-soft bg-white border '+(ok?'border-emerald-200 text-emerald-700':'border-rose-200 text-rose-700');
  div.textContent=msg; $('#toasts').appendChild(div); setTimeout(()=>div.remove(),4000);
}
function setSpin(id,on){ const el=$('#'+id); if(el) el.classList.toggle('hidden',!on); }
function fillSelect(sel, arr, ph='Selecciona...'){ const el=typeof sel==='string' ? $('#'+sel) : sel; if(!el) return; const keep=el.value; el.innerHTML=''; const o=document.createElement('option'); o.value=''; o.textContent=ph; el.appendChild(o); (arr||[]).forEach(v=>{ const opt=document.createElement('option'); opt.value=v; opt.textContent=v; el.appendChild(opt); }); el.value=keep; }
function toCSV(rows, headers){ const esc=s=>('"'+String(s??'').replace(/"/g,'""')+'"'); const head=headers.map(esc).join(','); const body=(rows||[]).map(r=>headers.map(h=>esc(r[h])).join(',')).join('\n'); return head+'\n'+body; }

let META={indicadores:[],localidades:[],upz:[],años:[], cohortes:['10-14','15-19']};
let charts={}; let CARAC=[], ASOC=[], BRECHA=[];

// Tabs
$$('.tabs button').forEach(b=>b.addEventListener('click', e=>{
  const id=b.dataset.tab;
  $$('.tabs button').forEach(x=>x.setAttribute('aria-selected', x===b));
  ['obj1','obj2','obj3','obj4'].forEach(x=>$('#'+x).classList.toggle('hidden', x!==id));
}));

// API helpers
async function apiGet(path, params){
  const url=new URL(path, location.origin);
  if(params){ for(const[k,v] of Object.entries(params)){ if(v!=='' && v!=null) url.searchParams.append(k, v); } }
  const res=await fetch(url); if(!res.ok) throw new Error((await res.text())||res.statusText); return res.json();
}
async function apiPostFile(path, file){ const fd=new FormData(); fd.append('file', file); const res=await fetch(path,{method:'POST', body:fd}); if(!res.ok) throw new Error((await res.text())||res.statusText); return res.json(); }

// Load meta & KPIs
async function loadMeta(){
  const meta=await apiGet('/metadatos'); META=meta;
  fillSelect('selIndicador', meta.indicadores, 'Indicador...');
  fillSelect('selIndObj', (meta.indicadores||[]).filter(i=>/fecund/i.test(i)).length ? (meta.indicadores||[]).filter(i=>/fecund/i.test(i)) : meta.indicadores, 'Fecundidad (o elegir)...');
  fillSelect('selIndSerie', meta.indicadores, 'Indicador...');
  fillSelect('selIndicadorBrecha', meta.indicadores, 'Indicador...');
  fillSelect('selAnio', meta.años, '(opcional)');
  fillSelect('selAnioAsoc', meta.años, '(opcional)');
  fillSelect('selAnioBrecha', meta.años, '(opcional)');
  updateTerritoriosSerie();
}
async function loadKPI(){
  try{
    const s=await apiGet('/estadisticas/generales');
    $('#kTotal').textContent=s.total_registros ?? '—';
    $('#kIndicadores').textContent=s.indicadores_unicos ?? '—';
    $('#kLocs').textContent=s.localidades_unicas ?? '—';
    $('#kUpz').textContent=s.upzs_unicas ?? '—';
  }catch{}
}
function updateTerritoriosSerie(){
  const nivel=$('#selNivelSerie').value || 'LOCALIDAD';
  fillSelect('selTerrSerie', nivel==='LOCALIDAD' ? META.localidades : META.upz, nivel==='LOCALIDAD' ? 'Localidad...' : 'UPZ...');
}

// Upload
async function upload(){
  const f=$('#file').files[0]; if(!f){ toast('Selecciona un archivo .xlsx', false); return; }
  setSpin('uploadSpin', true);
  try{ const out=await apiPostFile('/upload/excel', f); $('#uploadOut').textContent=JSON.stringify(out, null, 2); toast('Archivo cargado correctamente.'); await loadMeta(); await loadKPI(); }
  catch(e){ toast('Error subiendo archivo: '+e.message, false); }
  finally{ setSpin('uploadSpin', false); }
}

// OBJ 1
async function runCaracterizacion(){
  const indicador=$('#selIndicador').value, nivel=$('#selNivel').value||'LOCALIDAD', año=$('#selAnio').value||'', cohorte=$('#selCohorte').value||'';
  if(!indicador){ toast('Selecciona un indicador', false); return; }
  const js=await apiGet('/caracterizacion', {indicador, nivel, 'año':año, cohorte});
  const rows=js.datos||[]; CARAC=rows;
  // tabla
  const tb=$('#tblCarac tbody'); tb.innerHTML=rows.map(o=>`<tr><td class="p-2 border">${o.territorio}</td><td class="p-2 border">${o.n}</td><td class="p-2 border">${o.promedio}</td><td class="p-2 border">${o.mediana}</td><td class="p-2 border">${o.q1}</td><td class="p-2 border">${o.q3}</td><td class="p-2 border">${o.min}</td><td class="p-2 border">${o.max}</td><td class="p-2 border">${o.desv_estandar}</td><td class="p-2 border">${o.cv_pct}</td></tr>`).join('');
  // chart
  const top=rows.slice(0,15);
  const data={labels: top.map(r=>r.territorio), datasets: [{label:`Promedio — ${indicador} (${nivel}${año? ' · '+año:''}${cohorte? ' · '+cohorte:''})`, data: top.map(r=>r.promedio), borderWidth:1, backgroundColor:'#3b82f6'}]};
  if(charts.carac) charts.carac.destroy();
  charts.carac=new Chart($('#chartCarac'), {type:'bar', data, options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:false}}}}});
}

// OBJ 2
async function runAsociacion(){
  const ind=$('#selIndObj').value, nivel=$('#selNivelAsoc').value||'LOCALIDAD', año=$('#selAnioAsoc').value||'', top=$('#inpTop').value||10, cohorte=$('#selCohorteAsoc').value||'';
  if(!ind){ toast('Selecciona el indicador objetivo', false); return; }
  const js=await apiGet('/analisis/asociacion', {indicador_objetivo:ind, nivel, 'año':año, top, cohorte});
  const rows=js.comparaciones||[]; ASOC=rows;
  const tb=$('#tblAsoc tbody');
  tb.innerHTML=rows.map(o=>`<tr>
    <td class="p-2 border">${o.indicador_comparado}</td>
    <td class="p-2 border">${o.territorios}</td>
    <td class="p-2 border">${o.pearson_r} (${o.pearson_p})</td>
    <td class="p-2 border">${o.spearman_rho} (${o.spearman_p})</td>
    <td class="p-2 border"><button class="btn text-xs" onclick="verDispersion('${ind}','${nivel}','${año}','${o.indicador_comparado}','${cohorte}')"><i class="ti ti-chart-dots"></i> Ver</button></td>
  </tr>`).join('');
  if(charts.disp) charts.disp.destroy(); $('#dispMeta').textContent='Seleccione una fila para visualizar.';
}

async function verDispersion(indObj, nivel, año, indX, cohorte){
  const y=await apiGet('/caracterizacion', {indicador:indObj, nivel, 'año':año, cohorte});
  const x=await apiGet('/caracterizacion', {indicador:indX, nivel, 'año':año, cohorte});
  const mapY=new Map((y.datos||[]).map(r=>[r.territorio, r.promedio]));
  const pares=(x.datos||[]).filter(r=>mapY.has(r.territorio)).map(r=>({x:r.promedio, y:mapY.get(r.territorio)}));
  if(!pares.length){ toast('Sin territorios comunes', false); return; }
  if(charts.disp) charts.disp.destroy();
  charts.disp=new Chart($('#chartDisp'), {type:'scatter', data:{datasets:[{label:`${indX} vs ${indObj}`, data:pares}]}, options:{plugins:{legend:{display:false}}, scales:{x:{title:{display:true,text:indX}}, y:{title:{display:true,text:indObj}}}}});
  $('#dispMeta').textContent=`Puntos: ${pares.length}`;
}

// OBJ 3
async function runBrechas(){
  const indicador=$('#selIndicadorBrecha').value, nivel=$('#selNivelBrecha').value||'LOCALIDAD', año=$('#selAnioBrecha').value||'';
  if(!indicador){ toast('Selecciona un indicador', false); return; }
  const js=await apiGet('/brechas/cohortes', {indicador, nivel, 'año':año});
  const rows=js.datos||[]; BRECHA=rows;
  const tb=$('#tblBrecha tbody');
  tb.innerHTML=rows.map(o=>`<tr><td class="p-2 border">${o.territorio}</td><td class="p-2 border">${o.prom_10_14}</td><td class="p-2 border">${o.prom_15_19}</td><td class="p-2 border">${o.brecha_abs}</td><td class="p-2 border">${o.brecha_rel??''}</td></tr>`).join('');
  // chart
  const top=rows.slice(0,15);
  const data={labels: top.map(r=>r.territorio), datasets:[{label:'Brecha (15–19 - 10–14)', data: top.map(r=>r.brecha_abs), backgroundColor:'#60a5fa'}]};
  if(charts.brecha) charts.brecha.destroy();
  charts.brecha=new Chart($('#chartBrecha'), {type:'bar', data, options:{responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:false}}}}});
}

// OBJ 4
async function runSerie(){
  const indicador=$('#selIndSerie').value, nivel=$('#selNivelSerie').value||'LOCALIDAD', terr=$('#selTerrSerie').value;
  if(!indicador||!terr){ toast('Selecciona indicador y territorio', false); return; }
  const j10=await apiGet('/datos/series', {indicador, territorio:terr, nivel, cohorte:'10-14'});
  const j15=await apiGet('/datos/series', {indicador, territorio:terr, nivel, cohorte:'15-19'});
  const s10=(j10.serie||[]), s15=(j15.serie||[]);
  const years=Array.from(new Set([...s10.map(x=>x.año), ...s15.map(x=>x.año)])).sort((a,b)=>a-b);
  const d10=years.map(y=>{ const p=s10.find(x=>x.año===y); return p? p.valor : null; });
  const d15=years.map(y=>{ const p=s15.find(x=>x.año===y); return p? p.valor : null; });
  if(charts.serie) charts.serie.destroy();
  charts.serie=new Chart($('#chartSerie'), {type:'line', data:{labels:years, datasets:[
    {label:'10–14', data:d10, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.3)', tension:.2},
    {label:'15–19', data:d15, borderColor:'#06b6d4', backgroundColor:'rgba(6,182,212,.3)', tension:.2}
  ]}, options:{plugins:{legend:{display:true}}, scales:{y:{beginAtZero:false}}}});
}

// Export
function downloadCSV(kind){
  let rows=[], headers=[];
  if(kind==='carac'){ rows=CARAC; headers=['territorio','n','promedio','mediana','q1','q3','min','max','desv_estandar','cv_pct']; }
  else if(kind==='asoc'){ rows=ASOC; headers=['indicador_comparado','territorios','pearson_r','pearson_p','spearman_rho','spearman_p']; }
  else if(kind==='brecha'){ rows=BRECHA; headers=['territorio','prom_10_14','prom_15_19','brecha_abs','brecha_rel']; }
  else { toast('Nada para exportar', false); return; }
  if(!rows.length){ toast('No hay datos para exportar', false); return; }
  const csv=toCSV(rows, headers); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=kind+'.csv'; a.click(); URL.revokeObjectURL(a.href);
}

// Init
$('#btnRefMeta').addEventListener('click', async()=>{ await loadMeta(); await loadKPI(); toast('Metadatos actualizados'); });
$('#selNivelSerie').addEventListener('change', updateTerritoriosSerie);
window.addEventListener('load', async()=>{ await loadMeta(); await loadKPI(); });
</script>
</body>
</html>
