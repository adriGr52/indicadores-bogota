<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard DEBUG - Fecundidad Temprana v4.3.1</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        .card { 
            background: #fff; 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            border: 1px solid #e5e7eb; 
            padding: 1rem;
        }
        .btn { 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem; 
            padding: 0.75rem 1rem; 
            border-radius: 0.375rem; 
            border: 1px solid #d1d5db; 
            background: #fff; 
            cursor: pointer; 
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .btn:hover { background: #f9fafb; }
        .btn-primary { background: #2563eb; border-color: #2563eb; color: #fff; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .alert { padding: 1rem; border-radius: 0.5rem; margin: 0.5rem 0; font-size: 0.875rem; }
        .alert-success { background: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .alert-error { background: #fef2f2; border: 1px solid #dc2626; color: #dc2626; }
        .alert-info { background: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        .alert-warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        
        .debug-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-log {
            margin: 0.25rem 0;
            padding: 0.25rem;
        }
        .debug-info { color: #3b82f6; }
        .debug-success { color: #10b981; }
        .debug-error { color: #ef4444; }
        .debug-warning { color: #f59e0b; }
        
        select, input { 
            width: 100%; 
            padding: 0.5rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.375rem; 
            font-size: 0.875rem;
        }
        select:focus, input:focus { 
            outline: none; 
            ring: 2px; 
            ring-color: #2563eb; 
            border-color: #2563eb; 
        }
        
        .spinner { 
            border: 2px solid #e5e7eb; 
            border-top-color: #2563eb; 
            border-radius: 50%; 
            width: 16px; 
            height: 16px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tabs button {
            background: #eff6ff;
            color: #1e3a8a;
            border: 1px solid #bfdbfe;
            padding: 0.75rem;
            text-align: center;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .tabs button[aria-selected="true"] {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-800 text-white p-4">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-xl font-bold">üõ†Ô∏è Dashboard DEBUG - Fecundidad Temprana v4.3.1</h1>
            <p class="text-sm text-blue-200">Modo debugging para identificar problemas de datos</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 space-y-4">
        <!-- Debug Panel -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold">üêõ Panel de Debugging</h2>
                <button id="btnClearLog" class="btn text-xs">Limpiar Log</button>
            </div>
            <div id="debugLog" class="debug-panel">
                <div class="debug-info">Sistema iniciado - Modo debugging activado</div>
            </div>
        </div>

        <!-- System Status -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card text-center">
                <div class="text-2xl font-bold" id="statusRegistros">-</div>
                <div class="text-sm text-gray-500">Registros BD</div>
                <div id="statusRegistrosIcon" class="mt-1">‚è≥</div>
            </div>
            <div class="card text-center">
                <div class="text-2xl font-bold" id="statusIndicadores">-</div>
                <div class="text-sm text-gray-500">Indicadores</div>
                <div id="statusIndicadoresIcon" class="mt-1">‚è≥</div>
            </div>
            <div class="card text-center">
                <div class="text-2xl font-bold" id="statusLocalidades">-</div>
                <div class="text-sm text-gray-500">Localidades</div>
                <div id="statusLocalidadesIcon" class="mt-1">‚è≥</div>
            </div>
            <div class="card text-center">
                <div class="text-2xl font-bold" id="statusUpz">-</div>
                <div class="text-sm text-gray-500">UPZ</div>
                <div id="statusUpzIcon" class="mt-1">‚è≥</div>
            </div>
        </div>

        <!-- Upload Section con m√°s debugging -->
        <div class="card">
            <h3 class="font-semibold mb-4">üìÇ Carga de Datos Excel</h3>
            <div class="grid md:grid-cols-3 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-2">Archivo Excel</label>
                    <input id="fileInput" type="file" accept=".xlsx,.xls">
                </div>
                <div>
                    <button id="btnUpload" class="btn btn-primary w-full">
                        <i class="ti ti-upload"></i> Subir y Analizar
                    </button>
                </div>
            </div>
            <div id="uploadResult" class="mt-4"></div>
        </div>

        <!-- API Testing -->
        <div class="card">
            <h3 class="font-semibold mb-4">üî¨ Pruebas de API</h3>
            <div class="grid md:grid-cols-3 gap-2">
                <button id="btnTestHealth" class="btn">Test Health</button>
                <button id="btnTestMetadatos" class="btn">Test Metadatos</button>
                <button id="btnTestData" class="btn">Test Datos</button>
            </div>
            <div id="apiTestResult" class="mt-4"></div>
        </div>

        <!-- Tabs simplificadas -->
        <div class="tabs">
            <button data-tab="debug" aria-selected="true">üîç Debug Completo</button>
            <button data-tab="caracterizacion">üìä Caracterizaci√≥n</button>
            <button data-tab="datos">üìã Ver Datos Raw</button>
        </div>

        <!-- Debug Tab -->
        <div id="tab-debug" class="card">
            <h3 class="font-semibold mb-4">üîç An√°lisis Completo de Datos</h3>
            
            <!-- Metadata Display -->
            <div class="space-y-4">
                <div>
                    <h4 class="font-semibold mb-2">Metadatos del Sistema:</h4>
                    <div id="metadataDisplay" class="debug-panel">
                        <div class="debug-info">Cargando metadatos...</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">Estructura de Base de Datos:</h4>
                    <div id="dbStructure" class="debug-panel">
                        <div class="debug-info">Analizando estructura...</div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold mb-2">Muestras de Datos:</h4>
                    <div id="dataSamples" class="debug-panel">
                        <div class="debug-info">Obteniendo muestras...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Caracterizaci√≥n Tab -->
        <div id="tab-caracterizacion" class="card hidden">
            <h3 class="font-semibold mb-4">üìä Caracterizaci√≥n (Modo Debug)</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Indicador</label>
                    <select id="caracIndicador">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Localidad</label>
                    <select id="caracLocalidad">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">UPZ</label>
                    <select id="caracUpz">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="btnCaracterizar" class="btn btn-primary w-full">Analizar</button>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-semibold mb-2">Gr√°fico</h4>
                    <div class="chart-container">
                        <canvas id="chartCaracterizacion"></canvas>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">Resultados Debug</h4>
                    <div id="caracResults" class="debug-panel">
                        <div class="debug-info">Selecciona un indicador para analizar</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos Raw Tab -->
        <div id="tab-datos" class="card hidden">
            <h3 class="font-semibold mb-4">üìã Datos Raw de la Base de Datos</h3>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <button id="btnGetRawData" class="btn btn-primary">Obtener Datos Raw</button>
                    <button id="btnAnalyzeColumns" class="btn">Analizar Columnas</button>
                    <input id="limitInput" type="number" placeholder="L√≠mite (ej: 100)" class="w-32" value="50">
                </div>
                <div id="rawDataDisplay" class="debug-panel">
                    <div class="debug-info">Haz click en "Obtener Datos Raw" para ver los datos</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Variables globales
        let debugLog = [];
        let charts = {};
        let currentData = {};

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push({ timestamp, message, type });
            
            const logDiv = document.createElement('div');
            logDiv.className = `debug-log debug-${type}`;
            logDiv.textContent = logEntry;
            
            const container = document.getElementById('debugLog');
            container.appendChild(logDiv);
            container.scrollTop = container.scrollHeight;
            
            console.log(`[DEBUG-${type.toUpperCase()}]`, message);
        }

        function updateStatus(elementId, iconId, value, status = 'success') {
            document.getElementById(elementId).textContent = value;
            const icon = document.getElementById(iconId);
            if (status === 'success') {
                icon.textContent = '‚úÖ';
            } else if (status === 'error') {
                icon.textContent = '‚ùå';
            } else {
                icon.textContent = '‚è≥';
            }
        }

        function showResult(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${content}</div>`;
        }

        // API calls con logging detallado
        async function apiCall(endpoint, options = {}) {
            try {
                log(`API Call: ${endpoint}`, 'info');
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const responseText = await response.text();
                log(`API Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    log(`API Error Response: ${responseText}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${responseText}`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    log(`API Data received: ${Object.keys(data).join(', ')}`, 'success');
                } catch (e) {
                    log(`Error parsing JSON response: ${e.message}`, 'error');
                    throw new Error('Invalid JSON response');
                }
                
                return data;
            } catch (error) {
                log(`API Call failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test individual endpoints
        async function testHealth() {
            try {
                const data = await apiCall('/health');
                log(`Health check OK - Version: ${data.version}, DB: ${data.database}`, 'success');
                showResult('apiTestResult', `
                    <strong>‚úÖ Health Check OK</strong><br>
                    Version: ${data.version}<br>
                    Database: ${data.database}<br>
                    Registros: ${data.registros}<br>
                    Timestamp: ${data.timestamp}
                `, 'success');
                return data;
            } catch (error) {
                showResult('apiTestResult', `‚ùå Health check failed: ${error.message}`, 'error');
                return null;
            }
        }

        async function testMetadatos() {
            try {
                const data = await apiCall('/metadatos');
                log(`Metadatos OK - Indicadores: ${data.indicadores?.todos?.length || 0}`, 'success');
                
                const resumen = data.resumen || {};
                showResult('apiTestResult', `
                    <strong>‚úÖ Metadatos OK</strong><br>
                    Total registros: ${resumen.total_registros || 0}<br>
                    Indicadores: ${resumen.total_indicadores || 0}<br>
                    Localidades: ${resumen.localidades || 0}<br>
                    UPZ: ${resumen.upz || 0}
                `, 'success');
                
                // Update status
                updateStatus('statusRegistros', 'statusRegistrosIcon', resumen.total_registros || 0);
                updateStatus('statusIndicadores', 'statusIndicadoresIcon', resumen.total_indicadores || 0);
                updateStatus('statusLocalidades', 'statusLocalidadesIcon', resumen.localidades || 0);
                updateStatus('statusUpz', 'statusUpzIcon', resumen.upz || 0);
                
                // Update metadata display
                document.getElementById('metadataDisplay').innerHTML = `
                    <div class="debug-success">‚úÖ Metadatos cargados correctamente</div>
                    <div class="debug-info">Total registros: ${resumen.total_registros || 0}</div>
                    <div class="debug-info">Indicadores √∫nicos: ${resumen.total_indicadores || 0}</div>
                    <div class="debug-info">Localidades: ${resumen.localidades || 0}</div>
                    <div class="debug-info">UPZ: ${resumen.upz || 0}</div>
                    <div class="debug-info">Rango a√±os: ${resumen.rango_a√±os?.min || 'N/A'} - ${resumen.rango_a√±os?.max || 'N/A'}</div>
                `;
                
                // Populate selectors
                if (data.indicadores?.todos) {
                    populateSelect('caracIndicador', data.indicadores.todos);
                    log(`Populated indicadores selector with ${data.indicadores.todos.length} items`, 'success');
                }
                
                if (data.geografia?.localidades) {
                    populateSelect('caracLocalidad', data.geografia.localidades);
                    log(`Populated localidades selector with ${data.geografia.localidades.length} items`, 'success');
                }
                
                currentData = data;
                return data;
            } catch (error) {
                showResult('apiTestResult', `‚ùå Metadatos failed: ${error.message}`, 'error');
                document.getElementById('metadataDisplay').innerHTML = `
                    <div class="debug-error">‚ùå Error cargando metadatos: ${error.message}</div>
                `;
                return null;
            }
        }

        async function testData() {
            try {
                // Test a simple caracterizaci√≥n call
                const data = await apiCall('/caracterizacion?indicador=test&nivel=UPZ');
                if (data.mensaje) {
                    log(`Caracterizaci√≥n test: ${data.mensaje}`, 'warning');
                    showResult('apiTestResult', `‚ö†Ô∏è Caracterizaci√≥n: ${data.mensaje}`, 'warning');
                } else {
                    log(`Caracterizaci√≥n test OK - ${data.datos?.length || 0} UPZ`, 'success');
                    showResult('apiTestResult', `‚úÖ Caracterizaci√≥n OK - ${data.datos?.length || 0} UPZ encontradas`, 'success');
                }
                return data;
            } catch (error) {
                showResult('apiTestResult', `‚ùå Data test failed: ${error.message}`, 'error');
                return null;
            }
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select || !options) {
                log(`Cannot populate select ${selectId} - missing element or options`, 'error');
                return;
            }
            
            // Keep first option
            const firstOption = select.children[0];
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option.length > 60 ? option.substring(0, 57) + '...' : option;
                optionElement.title = option;
                select.appendChild(optionElement);
            });
            
            log(`Populated ${selectId} with ${options.length} options`, 'info');
        }

        // Tab management
        function initTabs() {
            document.querySelectorAll('.tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Update buttons
                    document.querySelectorAll('.tabs button').forEach(b => b.setAttribute('aria-selected', 'false'));
                    button.setAttribute('aria-selected', 'true');
                    
                    // Update content
                    document.querySelectorAll('[id^="tab-"]').forEach(tab => tab.classList.add('hidden'));
                    const targetTab = document.getElementById(`tab-${tabId}`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                    }
                    
                    log(`Switched to tab: ${tabId}`, 'info');
                });
            });
        }

        // Upload con debugging extensivo
        function initUpload() {
            document.getElementById('btnUpload').addEventListener('click', async () => {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    log('No file selected for upload', 'error');
                    showResult('uploadResult', 'Seleccione un archivo', 'error');
                    return;
                }
                
                log(`File selected: ${file.name} (${file.size} bytes)`, 'info');
                
                if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                    log('Invalid file type selected', 'error');
                    showResult('uploadResult', 'Solo se permiten archivos .xlsx o .xls', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                const btn = document.getElementById('btnUpload');
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner"></div> Procesando...';
                
                try {
                    log('Starting file upload...', 'info');
                    
                    const response = await fetch('/upload/excel', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        const stats = result.estadisticas || {};
                        log(`Upload successful - ${stats.registros_cargados || 0} records loaded`, 'success');
                        
                        showResult('uploadResult', `
                            <strong>‚úÖ Carga exitosa</strong><br>
                            üìÇ Archivo: ${result.archivo}<br>
                            üìä Registros cargados: ${stats.registros_cargados || 0}<br>
                            üìÑ Filas procesadas: ${stats.filas_procesadas || 0}<br>
                            ‚ö†Ô∏è Omitidos: ${stats.filas_omitidas_sin_valor || 0}<br>
                            ‚ùå Errores: ${stats.errores || 0}<br>
                            üéØ Indicadores √∫nicos: ${stats.indicadores_unicos || 0}
                        `, 'success');
                        
                        // Refresh metadata after upload
                        setTimeout(async () => {
                            await testMetadatos();
                        }, 1000);
                        
                    } else {
                        log(`Upload failed: ${result.detail}`, 'error');
                        showResult('uploadResult', `‚ùå Error: ${result.detail}`, 'error');
                    }
                } catch (error) {
                    log(`Upload error: ${error.message}`, 'error');
                    showResult('uploadResult', `‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="ti ti-upload"></i> Subir y Analizar';
                }
            });
        }

        // Caracterizaci√≥n
        function initCaracterizacion() {
            // Event listener for localidad change
            document.getElementById('caracLocalidad').addEventListener('change', async () => {
                const localidad = document.getElementById('caracLocalidad').value;
                if (!localidad) {
                    populateSelect('caracUpz', currentData.geografia?.upz || []);
                    return;
                }
                
                try {
                    const data = await apiCall(`/geografia/upz_por_localidad?localidad=${encodeURIComponent(localidad)}`);
                    populateSelect('caracUpz', data.upz || []);
                    log(`Updated UPZ for localidad ${localidad}: ${data.total} UPZ found`, 'info');
                } catch (error) {
                    log(`Error updating UPZ for localidad ${localidad}: ${error.message}`, 'error');
                }
            });
            
            document.getElementById('btnCaracterizar').addEventListener('click', async () => {
                const indicador = document.getElementById('caracIndicador').value;
                const localidad = document.getElementById('caracLocalidad').value;
                const upz = document.getElementById('caracUpz').value;
                
                if (!indicador) {
                    log('No indicator selected for caracterizaci√≥n', 'error');
                    showResult('caracResults', 'Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        nivel: 'UPZ',
                        ...(localidad && { localidad }),
                        ...(upz && { upz })
                    });
                    
                    log(`Running caracterizaci√≥n: ${params.toString()}`, 'info');
                    const data = await apiCall(`/caracterizacion?${params}`);
                    
                    if (data.mensaje) {
                        log(`Caracterizaci√≥n result: ${data.mensaje}`, 'warning');
                        document.getElementById('caracResults').innerHTML = `
                            <div class="debug-warning">${data.mensaje}</div>
                        `;
                    } else {
                        log(`Caracterizaci√≥n successful: ${data.datos?.length || 0} UPZ analyzed`, 'success');
                        
                        document.getElementById('caracResults').innerHTML = `
                            <div class="debug-success">‚úÖ An√°lisis completado</div>
                            <div class="debug-info">UPZ analizadas: ${data.total_upz || 0}</div>
                            <div class="debug-info">Unidad: ${data.unidad_medida}</div>
                            <div class="debug-info">Promedio general: ${data.resumen?.promedio_general || 'N/A'}</div>
                            <div class="debug-info">Total observaciones: ${data.resumen?.n_total || 0}</div>
                            <hr style="margin: 0.5rem 0;">
                            <div class="debug-info">Top 5 UPZ:</div>
                            ${(data.datos || []).slice(0, 5).map(d => `
                                <div class="debug-info">‚Ä¢ ${d.upz}: ${d.promedio} (n=${d.n})</div>
                            `).join('')}
                        `;
                        
                        // Create simple chart
                        renderSimpleChart(data);
                    }
                } catch (error) {
                    log(`Caracterizaci√≥n error: ${error.message}`, 'error');
                    document.getElementById('caracResults').innerHTML = `
                        <div class="debug-error">‚ùå Error: ${error.message}</div>
                    `;
                }
            });
        }

        function renderSimpleChart(data) {
            const canvas = document.getElementById('chartCaracterizacion');
            const ctx = canvas.getContext('2d');
            
            if (charts['caracterizacion']) {
                charts['caracterizacion'].destroy();
            }
            
            const top10 = (data.datos || []).slice(0, 10);
            
            charts['caracterizacion'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.upz.length > 15 ? d.upz.substring(0, 12) + '...' : d.upz),
                    datasets: [{
                        label: data.unidad_medida,
                        data: top10.map(d => d.promedio),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: data.indicador.length > 40 ? data.indicador.substring(0, 37) + '...' : data.indicador
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: data.unidad_medida }
                        }
                    }
                }
            });
            
            log('Chart rendered successfully', 'success');
        }

        // Raw data viewer
        function initRawData() {
            document.getElementById('btnGetRawData').addEventListener('click', async () => {
                const limit = document.getElementById('limitInput').value || 50;
                
                try {
                    log(`Fetching raw data (limit: ${limit})...`, 'info');
                    
                    // Since we don't have a direct raw data endpoint, let's use debug/columns and a test query
                    const columnsData = await apiCall('/debug/columns');
                    
                    document.getElementById('rawDataDisplay').innerHTML = `
                        <div class="debug-success">‚úÖ Estructura de columnas obtenida</div>
                        <div class="debug-info">Columnas requeridas:</div>
                        ${columnsData.columnas_requeridas.map(col => `<div class="debug-info">‚Ä¢ ${col}</div>`).join('')}
                        <div class="debug-info">Columnas opcionales (primeras 10):</div>
                        ${columnsData.columnas_opcionales.slice(0, 10).map(col => `<div class="debug-info">‚Ä¢ ${col}</div>`).join('')}
                        <div class="debug-info">Ejemplo estructura:</div>
                        <pre style="font-size: 0.7rem; background: #fff; padding: 0.5rem; border-radius: 0.25rem; margin: 0.5rem 0;">${JSON.stringify(columnsData.ejemplo_estructura, null, 2)}</pre>
                    `;
                    
                    log('Raw data structure displayed', 'success');
                    
                } catch (error) {
                    log(`Error getting raw data: ${error.message}`, 'error');
                    document.getElementById('rawDataDisplay').innerHTML = `
                        <div class="debug-error">‚ùå Error: ${error.message}</div>
                    `;
                }
            });
            
            document.getElementById('btnAnalyzeColumns').addEventListener('click', async () => {
                try {
                    log('Analyzing database structure...', 'info');
                    
                    const data = await apiCall('/debug/columns');
                    
                    document.getElementById('dbStructure').innerHTML = `
                        <div class="debug-success">‚úÖ Estructura analizada</div>
                        <div class="debug-info">Columnas requeridas: ${data.columnas_requeridas?.length || 0}</div>
                        <div class="debug-info">Columnas opcionales: ${data.columnas_opcionales?.length || 0}</div>
                        ${data.mejoras_v431 ? `
                            <div class="debug-success">Mejoras v4.3.1 detectadas:</div>
                            ${data.mejoras_v431.map(mejora => `<div class="debug-info">‚Ä¢ ${mejora}</div>`).join('')}
                        ` : ''}
                    `;
                    
                    log('Database structure analyzed', 'success');
                    
                } catch (error) {
                    log(`Error analyzing columns: ${error.message}`, 'error');
                    document.getElementById('dbStructure').innerHTML = `
                        <div class="debug-error">‚ùå Error: ${error.message}</div>
                    `;
                }
            });
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async () => {
            log('DOM loaded, initializing debug dashboard...', 'info');
            
            initTabs();
            initUpload();
            initCaracterizacion();
            initRawData();
            
            // Clear log button
            document.getElementById('btnClearLog').addEventListener('click', () => {
                debugLog = [];
                document.getElementById('debugLog').innerHTML = '<div class="debug-info">Log cleared</div>';
            });
            
            // API test buttons
            document.getElementById('btnTestHealth').addEventListener('click', testHealth);
            document.getElementById('btnTestMetadatos').addEventListener('click', testMetadatos);
            document.getElementById('btnTestData').addEventListener('click', testData);
            
            // Auto-run initial tests
            log('Running initial system tests...', 'info');
            await testHealth();
            await testMetadatos();
            
            log('Debug dashboard initialized successfully', 'success');
        });
    </script>
</body>
</html>
