<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fecundidad Temprana Bogot√°</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT:'#1e3a8a', 50:'#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a' },
                        accent: { DEFAULT:'#06b6d4' }
                    }
                }
            }
        }
    </script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <style>
        .card { background:#fff; border-radius:1rem; box-shadow:0 10px 20px rgba(2, 6, 23, .04), 0 2px 6px rgba(2, 6, 23, .06); border:1px solid #e2e8f0; }
        .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .85rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; transition: all .15s; cursor: pointer; }
        .btn:hover { background:#f8fafc; transform: translateY(-1px); }
        .btn-primary { background:#2563eb; border-color:#2563eb; color:#fff; }
        .btn-primary:hover { background:#1d4ed8; }
        .chip { display:inline-flex; align-items:center; gap:.25rem; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; background:#e0f2fe; color:#075985; }
        .pill { display:inline-flex; align-items:center; gap:.375rem; border-radius:999px; padding:.125rem .5rem; font-size:.75rem; background:#eef2ff; color:#3730a3; }
        .muted { color:#64748b; }
        .kpi { font-size:1.75rem; font-weight:700; }
        .grad { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 40%, #06b6d4 100%); }
        .shadow-soft { box-shadow: 0 10px 20px rgba(2,6,23,.08), 0 3px 8px rgba(2,6,23,.1); }
        .spinner { border:3px solid #e5e7eb; border-top-color:#2563eb; border-radius:999px; width:20px; height:20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tabs button[aria-selected="true"] { background:#1e40af; color:white; }
        .tabs button { background:#eff6ff; color:#1e3a8a; border:1px solid #bfdbfe; }
        .loading { opacity: 0.5; pointer-events: none; }
        .alert { padding: 1rem; border-radius: 0.75rem; margin: 1rem 0; }
        .alert-success { background: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .alert-error { background: #fef2f2; border: 1px solid #dc2626; color: #dc2626; }
        .alert-info { background: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- Header -->
    <header class="grad text-white">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
                        üèõÔ∏è Exploraci√≥n Determinantes Fecundidad Temprana
                    </h1>
                    <p class="mt-1 text-slate-100/90">
                        Bogot√° D.C. ‚Ä¢ An√°lisis territorial por cohortes (10-14, 15-19)
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <a class="btn btn-primary shadow-soft" href="/docs" target="_blank">
                        <i class="ti ti-api"></i> API Docs
                    </a>
                    <button id="btnRefresh" class="btn shadow-soft">
                        <i class="ti ti-refresh"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">
        <!-- KPIs -->
        <section class="grid md:grid-cols-4 gap-4">
            <div class="card p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-sm">Registros</span>
                    <span class="pill">Total</span>
                </div>
                <div id="kpiTotal" class="kpi mt-1">-</div>
                <div class="muted text-xs">Datos cargados</div>
            </div>
            <div class="card p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-sm">Indicadores</span>
                    <span class="pill">√önicos</span>
                </div>
                <div id="kpiIndicadores" class="kpi mt-1">-</div>
                <div class="muted text-xs">Variables disponibles</div>
            </div>
            <div class="card p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-sm">Localidades</span>
                    <span class="pill">Cobertura</span>
                </div>
                <div id="kpiLocalidades" class="kpi mt-1">-</div>
                <div class="muted text-xs">Territorios</div>
            </div>
            <div class="card p-4">
                <div class="flex items-center justify-between">
                    <span class="muted text-sm">UPZ</span>
                    <span class="pill">Cobertura</span>
                </div>
                <div id="kpiUpz" class="kpi mt-1">-</div>
                <div class="muted text-xs">Unidades territoriales</div>
            </div>
        </section>

        <!-- Upload Section -->
        <section class="card p-5">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-semibold text-primary-800 flex items-center gap-2">
                    <i class="ti ti-upload"></i> Carga de Datos
                </h2>
                <span class="chip">POST /upload/excel</span>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Archivo Excel (.xlsx, .xls)</label>
                    <input id="fileInput" type="file" accept=".xlsx,.xls" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div class="flex items-end gap-2">
                    <button id="btnUpload" class="btn btn-primary">
                        <i class="ti ti-cloud-upload"></i> Subir Archivo
                    </button>
                    <div id="uploadSpinner" class="hidden spinner"></div>
                </div>
            </div>
            <div id="uploadResult" class="mt-4"></div>
        </section>

        <!-- Analysis Tabs -->
        <section class="space-y-4">
            <div class="tabs flex flex-wrap gap-2">
                <button class="btn" data-tab="caracterizacion" aria-selected="true">
                    <i class="ti ti-chart-bar"></i> Caracterizaci√≥n
                </button>
                <button class="btn" data-tab="asociacion">
                    <i class="ti ti-chart-dots"></i> Asociaci√≥n
                </button>
                <button class="btn" data-tab="theil">
                    <i class="ti ti-balance"></i> Desigualdad (Theil)
                </button>
                <button class="btn" data-tab="series">
                    <i class="ti ti-trending-up"></i> Series Temporales
                </button>
                <button class="btn" data-tab="brechas">
                    <i class="ti ti-arrows-diff"></i> Brechas Cohortes
                </button>
            </div>

            <!-- Caracterizaci√≥n -->
            <div id="tab-caracterizacion" class="card p-5 space-y-4">
                <h3 class="text-lg font-semibold text-primary-800">Caracterizaci√≥n Territorial</h3>
                
                <div class="grid md:grid-cols-5 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="caracIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="caracNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cohorte</label>
                        <select id="caracCohorte" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Ambas</option>
                            <option value="10-14">10-14</option>
                            <option value="15-19">15-19</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">A√±o</label>
                        <select id="caracAno" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnCaracterizar" class="btn btn-primary w-full">
                            <i class="ti ti-chart-bar"></i> Analizar
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold">Top 10 Territorios</h4>
                            <button id="btnDownloadCarac" class="btn text-xs">
                                <i class="ti ti-download"></i> CSV
                            </button>
                        </div>
                        <canvas id="chartCaracterizacion" height="250"></canvas>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">Estad√≠sticas Descriptivas</h4>
                        <div class="overflow-auto max-h-80">
                            <table id="tableCaracterizacion" class="w-full text-sm">
                                <thead class="bg-primary-50 text-primary-900 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left">Territorio</th>
                                        <th class="p-2 text-right">N</th>
                                        <th class="p-2 text-right">Promedio</th>
                                        <th class="p-2 text-right">Mediana</th>
                                        <th class="p-2 text-right">CV%</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Asociaci√≥n -->
            <div id="tab-asociacion" class="card p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">An√°lisis de Asociaci√≥n</h3>
                
                <div class="grid md:grid-cols-5 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador X</label>
                        <select id="asocIndicadorX" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador Y</label>
                        <select id="asocIndicadorY" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="asocNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cohorte</label>
                        <select id="asocCohorte" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Ambas</option>
                            <option value="10-14">10-14</option>
                            <option value="15-19">15-19</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnAsociar" class="btn btn-primary w-full">
                            <i class="ti ti-chart-dots"></i> Correlacionar
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">Dispersi√≥n</h4>
                        <canvas id="chartAsociacion" height="250"></canvas>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">Estad√≠sticas de Correlaci√≥n</h4>
                        <div id="resultadoAsociacion" class="space-y-3">
                            <p class="text-gray-500">Seleccione dos indicadores para ver la correlaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theil -->
            <div id="tab-theil" class="card p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">√çndice de Theil - Desigualdad Territorial</h3>
                
                <div class="grid md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="theilIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="theilNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cohorte</label>
                        <select id="theilCohorte" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Ambas</option>
                            <option value="10-14">10-14</option>
                            <option value="15-19">15-19</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnTheil" class="btn btn-primary w-full">
                            <i class="ti ti-balance"></i> Calcular
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">√çndice de Desigualdad</h4>
                        <div id="theilResultado" class="space-y-4">
                            <div class="text-center">
                                <div class="text-4xl font-bold text-gray-400" id="theilValor">-</div>
                                <div class="text-sm text-gray-500">√çndice de Theil</div>
                                <div class="mt-2">
                                    <span id="theilCategoria" class="px-3 py-1 rounded-full text-sm bg-gray-100">
                                        Seleccionar indicador
                                    </span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded">
                                <strong>Interpretaci√≥n:</strong> 0 = igualdad perfecta, >0 = mayor desigualdad
                            </div>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">Distribuci√≥n por Territorio</h4>
                        <canvas id="chartTheil" height="250"></canvas>
                    </div>
                </div>
            </div>

            <!-- Series -->
            <div id="tab-series" class="card p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">Series Temporales</h3>
                
                <div class="grid md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="serieIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Territorio</label>
                        <select id="serieTerritorio" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="serieNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnSerie" class="btn btn-primary w-full">
                            <i class="ti ti-trending-up"></i> Generar Serie
                        </button>
                    </div>
                </div>

                <div class="card p-4">
                    <h4 class="font-semibold mb-3">Evoluci√≥n Temporal por Cohortes</h4>
                    <canvas id="chartSeries" height="300"></canvas>
                </div>
            </div>

            <!-- Brechas -->
            <div id="tab-brechas" class="card p-5 space-y-4 hidden">
                <h3 class="text-lg font-semibold text-primary-800">Brechas entre Cohortes</h3>
                
                <div class="grid md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">Indicador</label>
                        <select id="brechaIndicador" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Nivel</label>
                        <select id="brechaNivel" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="LOCALIDAD">LOCALIDAD</option>
                            <option value="UPZ">UPZ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">A√±o</label>
                        <select id="brechaAno" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnBrechas" class="btn btn-primary w-full">
                            <i class="ti ti-arrows-diff"></i> Calcular Brechas
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">Brecha por Territorio (15-19 - 10-14)</h4>
                        <canvas id="chartBrechas" height="250"></canvas>
                    </div>
                    <div class="card p-4">
                        <h4 class="font-semibold mb-3">Resumen de Brechas</h4>
                        <div class="overflow-auto max-h-64">
                            <table id="tableBrechas" class="w-full text-sm">
                                <thead class="bg-primary-50 text-primary-900 sticky top-0">
                                    <tr>
                                        <th class="p-2 text-left">Territorio</th>
                                        <th class="p-2 text-right">10-14</th>
                                        <th class="p-2 text-right">15-19</th>
                                        <th class="p-2 text-right">Brecha</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <script>
        // Utility functions
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        
        let charts = {};
        let metadata = {};
        
        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} shadow-lg max-w-sm animate-fade-in`;
            toast.textContent = message;
            
            $('#toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }
        
        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast(`Error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Load metadata
        async function loadMetadata() {
            try {
                metadata = await apiCall('/metadatos');
                updateKPIs();
                populateSelectors();
                showToast('Metadatos cargados correctamente', 'success');
            } catch (error) {
                showToast('Error cargando metadatos', 'error');
            }
        }
        
        // Update KPIs
        function updateKPIs() {
            $('#kpiTotal').textContent = metadata.resumen?.total_registros || '-';
            $('#kpiIndicadores').textContent = metadata.resumen?.total_indicadores || '-';
            $('#kpiLocalidades').textContent = metadata.resumen?.localidades || '-';
            $('#kpiUpz').textContent = metadata.resumen?.upz || '-';
        }
        
        // Populate selectors
        function populateSelectors() {
            const indicadores = metadata.indicadores?.todos || [];
            const a√±os = metadata.temporal?.a√±os || [];
            const localidades = metadata.geografia?.localidades || [];
            const upz = metadata.geografia?.upz || [];
            
            // Indicadores
            populateSelect('caracIndicador', indicadores);
            populateSelect('asocIndicadorX', indicadores);
            populateSelect('asocIndicadorY', indicadores);
            populateSelect('theilIndicador', indicadores);
            populateSelect('serieIndicador', indicadores);
            populateSelect('brechaIndicador', indicadores);
            
            // A√±os
            populateSelect('caracAno', a√±os);
            populateSelect('brechaAno', a√±os);
            
            // Territorios (inicialmente localidades)
            populateSelect('serieTerritorio', localidades);
        }
        
        function populateSelect(selectId, options) {
            const select = $(`#${selectId}`);
            if (!select) return;
            
            // Keep first option (placeholder)
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }
        
        // Tab management
        function initTabs() {
            $$('.tabs button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // Update buttons
                    $$('.tabs button').forEach(b => b.setAttribute('aria-selected', 'false'));
                    button.setAttribute('aria-selected', 'true');
                    
                    // Update content
                    $$('[id^="tab-"]').forEach(tab => tab.classList.add('hidden'));
                    $(`#tab-${tabId}`).classList.remove('hidden');
                });
            });
        }
        
        // File upload
        function initUpload() {
            $('#btnUpload').addEventListener('click', async () => {
                const fileInput = $('#fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('Seleccione un archivo', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                const spinner = $('#uploadSpinner');
                const btn = $('#btnUpload');
                
                try {
                    spinner.classList.remove('hidden');
                    btn.disabled = true;
                    
                    const response = await fetch('/upload/excel', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        $('#uploadResult').innerHTML = `
                            <div class="alert alert-success">
                                <strong>‚úÖ Carga exitosa</strong><br>
                                Registros cargados: ${result.estadisticas?.registros_cargados || 0}<br>
                                Errores: ${result.estadisticas?.errores || 0}
                            </div>
                        `;
                        showToast('Archivo cargado correctamente', 'success');
                        await loadMetadata();
                    } else {
                        throw new Error(result.detail || 'Error desconocido');
                    }
                } catch (error) {
                    $('#uploadResult').innerHTML = `
                        <div class="alert alert-error">
                            <strong>‚ùå Error en la carga</strong><br>
                            ${error.message}
                        </div>
                    `;
                    showToast('Error subiendo archivo', 'error');
                } finally {
                    spinner.classList.add('hidden');
                    btn.disabled = false;
                }
            });
        }
        
        // Caracterizaci√≥n
        function initCaracterizacion() {
            $('#btnCaracterizar').addEventListener('click', async () => {
                const indicador = $('#caracIndicador').value;
                const nivel = $('#caracNivel').value;
                const cohorte = $('#caracCohorte').value;
                const a√±o = $('#caracAno').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        nivel,
                        ...(cohorte && { cohorte }),
                        ...(a√±o && { a√±o })
                    });
                    
                    const data = await apiCall(`/caracterizacion?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderCaracterizacionChart(data);
                    renderCaracterizacionTable(data);
                    showToast('Caracterizaci√≥n completada', 'success');
                } catch (error) {
                    showToast('Error en caracterizaci√≥n', 'error');
                }
            });
        }
        
        function renderCaracterizacionChart(data) {
            const ctx = $('#chartCaracterizacion');
            const top10 = data.datos.slice(0, 10);
            
            if (charts.caracterizacion) {
                charts.caracterizacion.destroy();
            }
            
            charts.caracterizacion = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.territorio),
                    datasets: [{
                        label: `${data.indicador} (${data.unidad_medida})`,
                        data: top10.map(d => d.promedio),
                        backgroundColor: '#3b82f6',
                        borderColor: '#1d4ed8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        function renderCaracterizacionTable(data) {
            const tbody = $('#tableCaracterizacion tbody');
            tbody.innerHTML = data.datos.map(d => `
                <tr class="border-b">
                    <td class="p-2">${d.territorio}</td>
                    <td class="p-2 text-right">${d.n}</td>
                    <td class="p-2 text-right">${d.promedio}</td>
                    <td class="p-2 text-right">${d.mediana}</td>
                    <td class="p-2 text-right">${d.cv_pct}%</td>
                </tr>
            `).join('');
        }
        
        // Asociaci√≥n
        function initAsociacion() {
            $('#btnAsociar').addEventListener('click', async () => {
                const indicadorX = $('#asocIndicadorX').value;
                const indicadorY = $('#asocIndicadorY').value;
                const nivel = $('#asocNivel').value;
                const cohorte = $('#asocCohorte').value;
                
                if (!indicadorX || !indicadorY) {
                    showToast('Seleccione ambos indicadores', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador_x: indicadorX,
                        indicador_y: indicadorY,
                        nivel,
                        ...(cohorte && { cohorte })
                    });
                    
                    const data = await apiCall(`/analisis/asociacion?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderAsociacionChart(data);
                    renderAsociacionStats(data);
                    showToast('An√°lisis de asociaci√≥n completado', 'success');
                } catch (error) {
                    showToast('Error en an√°lisis de asociaci√≥n', 'error');
                }
            });
        }
        
        function renderAsociacionChart(data) {
            const ctx = $('#chartAsociacion');
            
            if (charts.asociacion) {
                charts.asociacion.destroy();
            }
            
            charts.asociacion = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Territorios',
                        data: data.datos.map(d => ({ x: d.x, y: d.y })),
                        backgroundColor: '#06b6d4',
                        borderColor: '#0891b2',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: data.indicador_x 
                            }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: data.indicador_y 
                            }
                        }
                    }
                }
            });
        }
        
        function renderAsociacionStats(data) {
            const container = $('#resultadoAsociacion');
            const corr = data.correlacion;
            
            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Correlaci√≥n de Pearson:</span>
                        <span class="font-mono">${corr.pearson_r} (p=${corr.pearson_p})</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Correlaci√≥n de Spearman:</span>
                        <span class="font-mono">${corr.spearman_rho} (p=${corr.spearman_p})</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Categor√≠a:</span>
                        <span class="font-semibold">${corr.categoria}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Significativa (p<0.05):</span>
                        <span class="${corr.significativa ? 'text-green-600' : 'text-red-600'} font-semibold">
                            ${corr.significativa ? 'S√≠' : 'No'}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span>Territorios comunes:</span>
                        <span>${data.territorios_comunes}</span>
                    </div>
                </div>
            `;
        }
        
        // Theil Index
        function initTheil() {
            $('#btnTheil').addEventListener('click', async () => {
                const indicador = $('#theilIndicador').value;
                const nivel = $('#theilNivel').value;
                const cohorte = $('#theilCohorte').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        nivel,
                        ...(cohorte && { cohorte })
                    });
                    
                    const data = await apiCall(`/analisis/theil?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderTheilResults(data);
                    renderTheilChart(data);
                    showToast('√çndice de Theil calculado', 'success');
                } catch (error) {
                    showToast('Error calculando √≠ndice de Theil', 'error');
                }
            });
        }
        
        function renderTheilResults(data) {
            $('#theilValor').textContent = data.indice_theil;
            
            const categoria = data.interpretacion.categoria;
            const categoriaElement = $('#theilCategoria');
            
            categoriaElement.textContent = categoria;
            categoriaElement.className = `px-3 py-1 rounded-full text-sm ${
                categoria === 'Baja' ? 'bg-green-100 text-green-800' :
                categoria === 'Moderada' ? 'bg-yellow-100 text-yellow-800' :
                'bg-red-100 text-red-800'
            }`;
        }
        
        function renderTheilChart(data) {
            const ctx = $('#chartTheil');
            const top10 = data.datos.slice(0, 10);
            
            if (charts.theil) {
                charts.theil.destroy();
            }
            
            charts.theil = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.territorio),
                    datasets: [{
                        label: `Valor (${data.unidad_medida})`,
                        data: top10.map(d => d.valor),
                        backgroundColor: '#8b5cf6',
                        borderColor: '#7c3aed',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: { beginAtZero: true }
                    }
                }
            });
        }
        
        // Series Temporales
        function initSeries() {
            // Update territories based on level selection
            $('#serieNivel').addEventListener('change', () => {
                const nivel = $('#serieNivel').value;
                const territorios = nivel === 'LOCALIDAD' ? 
                    metadata.geografia?.localidades || [] : 
                    metadata.geografia?.upz || [];
                populateSelect('serieTerritorio', territorios);
            });
            
            $('#btnSerie').addEventListener('click', async () => {
                const indicador = $('#serieIndicador').value;
                const territorio = $('#serieTerritorio').value;
                const nivel = $('#serieNivel').value;
                
                if (!indicador || !territorio) {
                    showToast('Seleccione indicador y territorio', 'error');
                    return;
                }
                
                try {
                    // Get series for both cohorts
                    const params10 = new URLSearchParams({
                        indicador,
                        territorio,
                        nivel,
                        cohorte: '10-14'
                    });
                    
                    const params15 = new URLSearchParams({
                        indicador,
                        territorio,
                        nivel,
                        cohorte: '15-19'
                    });
                    
                    const [data10, data15] = await Promise.all([
                        apiCall(`/datos/series?${params10}`),
                        apiCall(`/datos/series?${params15}`)
                    ]);
                    
                    renderSeriesChart(data10, data15, { indicador, territorio });
                    showToast('Serie temporal generada', 'success');
                } catch (error) {
                    showToast('Error generando serie temporal', 'error');
                }
            });
        }
        
        function renderSeriesChart(data10, data15, metadata) {
            const ctx = $('#chartSeries');
            
            // Combine all years
            const a√±os10 = data10.serie?.map(s => s.a√±o) || [];
            const a√±os15 = data15.serie?.map(s => s.a√±o) || [];
            const allYears = [...new Set([...a√±os10, ...a√±os15])].sort();
            
            // Create datasets
            const valores10 = allYears.map(a√±o => {
                const punto = data10.serie?.find(s => s.a√±o === a√±o);
                return punto ? punto.valor : null;
            });
            
            const valores15 = allYears.map(a√±o => {
                const punto = data15.serie?.find(s => s.a√±o === a√±o);
                return punto ? punto.valor : null;
            });
            
            if (charts.series) {
                charts.series.destroy();
            }
            
            charts.series = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allYears,
                    datasets: [
                        {
                            label: '10-14 a√±os',
                            data: valores10,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.3,
                            pointRadius: 4
                        },
                        {
                            label: '15-19 a√±os',
                            data: valores15,
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.3,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${metadata.indicador} - ${metadata.territorio}`
                        },
                        legend: { display: true }
                    },
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: 'A√±o' 
                            }
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: data10.unidad_medida || data15.unidad_medida || 'Valor'
                            }
                        }
                    }
                }
            });
        }
        
        // Brechas
        function initBrechas() {
            $('#btnBrechas').addEventListener('click', async () => {
                const indicador = $('#brechaIndicador').value;
                const nivel = $('#brechaNivel').value;
                const a√±o = $('#brechaAno').value;
                
                if (!indicador) {
                    showToast('Seleccione un indicador', 'error');
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        indicador,
                        nivel,
                        ...(a√±o && { a√±o })
                    });
                    
                    const data = await apiCall(`/brechas/cohortes?${params}`);
                    
                    if (data.mensaje) {
                        showToast(data.mensaje, 'info');
                        return;
                    }
                    
                    renderBrechasChart(data);
                    renderBrechasTable(data);
                    showToast('An√°lisis de brechas completado', 'success');
                } catch (error) {
                    showToast('Error en an√°lisis de brechas', 'error');
                }
            });
        }
        
        function renderBrechasChart(data) {
            const ctx = $('#chartBrechas');
            const top10 = data.datos.slice(0, 10);
            
            if (charts.brechas) {
                charts.brechas.destroy();
            }
            
            charts.brechas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(d => d.territorio),
                    datasets: [{
                        label: `Brecha (${data.unidad_medida})`,
                        data: top10.map(d => d.brecha_abs),
                        backgroundColor: top10.map(d => d.brecha_abs >= 0 ? '#ef4444' : '#22c55e'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Brecha (15-19 - 10-14)'
                            }
                        }
                    }
                }
            });
        }
        
        function renderBrechasTable(data) {
            const tbody = $('#tableBrechas tbody');
            tbody.innerHTML = data.datos.slice(0, 20).map(d => `
                <tr class="border-b">
                    <td class="p-2">${d.territorio}</td>
                    <td class="p-2 text-right">${d.prom_10_14}</td>
                    <td class="p-2 text-right">${d.prom_15_19}</td>
                    <td class="p-2 text-right ${d.brecha_abs >= 0 ? 'text-red-600' : 'text-green-600'}">
                        ${d.brecha_abs}
                    </td>
                </tr>
            `).join('');
        }
        
        // CSV Download
        function initDownloads() {
            $('#btnDownloadCarac').addEventListener('click', () => {
                // This would implement CSV download functionality
                showToast('Funci√≥n de descarga en desarrollo', 'info');
            });
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            initUpload();
            initCaracterizacion();
            initAsociacion();
            initTheil();
            initSeries();
            initBrechas();
            initDownloads();
            
            // Refresh button
            $('#btnRefresh').addEventListener('click', loadMetadata);
            
            // Load initial data
            loadMetadata();
        });
    </script>
</body>
</html>
